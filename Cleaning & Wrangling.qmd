---
title: "Cleaning & Wrangling"
author: "Brooke Wainwright"
format: html
editor: visual
---

## Background

These data come from a common garden drought experiment in Davis, California investigating the functional trait strategies of California grassland plants from five different grassland communities spanning California's latitudinal precipitation gradient. There 10-12 species per community or provenance, each provenance has 16 plots (8 drought, 8 control) across 10 shelters (5 drought, 5 control). In 2022-2023, we focused on collecting whole plant traits, including reproductive investment. This study focuses on how these traits relate to reproductive investment depending on drought treatment, native status, or provenance. This document will clean and wrangle the many datasets and images associated with this study.

## Traits & Objectives

-   Reproductive allocation
-   End of Season biomass
-   Relative Growth Rate
-   Photosynthetic Rate
-   Leaf Mass Area
-   Leaf Area
-   WUE Height
-   Leaf Nitrogen
-   Date of first flower
-   Mid season biomass partial
-   Root biomass partial
-   Root:shoot ratio partial
-   Root diameter partial
-   Specific root length partial
-   Root nitrogen partial

Bring in, explore, clean, rectify outliers, organize each trait or group of traits and export as "...\_CLEAN"

## Setup

```{r}
#| message: false
#| warning: false
#| echo: false

library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
```

## Reproductive allocation & End of Season biomass

These data are still being processed in the lab. 

Tasks:
Determine outliers for veg mass and flower mass for each species
Remove outliers
Investigate outliers (when we're done)
Figure out how to average flower mass with 1-9 flower weights
Average flower masses per species and treatments, figure out how to apply those to individuals with no flower masses.

For now, read in what we have so far and create some preliminary figures and analyses.

```{r}
#| warning: false
## Read in Data
repro <- read_csv("Reproductive Allocation_2023_20250108.csv")
str(repro)
summary(repro)
head(repro)

```

## Clean up and create variables

Remove rows that have NA in the Flower Count row and in the Veg Mass Row. For now, also drop rows that don't have any flower masses. Ultimately this should be a function but slow code it for now.

```{r}
repro_narm_cc <- repro %>% 
  drop_na(Flower_Count) %>% 
  drop_na(Veg_Mass) %>% 
  drop_na(Flower_1_g)

summary(repro_narm_cc$Flower_Count)
summary(repro_narm_cc$Veg_Mass)
summary(repro_narm_cc$Flower_10_g)
summary(repro_narm_cc$Flower_5_g)

# Figure out how to average flower masses as long as at least Flower_1_g is entered. Come back and do this.

repro_cc_ef <- repro_narm_cc %>% 
  mutate(avg_fl_mass = (Flower_1_g + Flower_2_g + Flower_3_g + Flower_4_g + Flower_5_g + Flower_6_g + Flower_7_g + Flower_8_g + Flower_9_g + Flower_10_g)/10) %>% 
  mutate(total_fl_mass = Flower_Count*avg_fl_mass) %>% 
  mutate(RE = total_fl_mass/(total_fl_mass + Veg_Mass))

summary(repro_cc_ef)
```

## Join with keys

Bring in species names and Plot information including home community and drought treatment.

```{r}
plots <- read_csv("Plot_info copy.csv")
str(plots)
summary(plots)
head(plots)

spp <- read_csv("Species Codes copy.csv")
unique(spp$Sp_Code)
unique(repro_cc_ef$Species)

# need to pull out first two characters in string of plant ID to create a "plot" column

repro_cc_ef <- repro_cc_ef %>% 
  mutate(Plot = substr(Plant_ID, start = 1, stop = 2))
unique(repro_cc_ef$Plot)

repro_full <- left_join(repro_cc_ef,plots,by = join_by(Plot))

repro_full$Sp_Code <- repro_full$Species

repro_full <- left_join(repro_full,spp,by = join_by(Sp_Code))

repro_full <- repro_full %>% 
  select(
    Plant_ID,
    Sp_Code,
    Scientific_Name,
    Flower_Count,
    Veg_Mass,
    avg_fl_mass,
    total_fl_mass,
    RE,
    Population,
    Treatment
  )

```

## Determine average flower mass per species per treatment

```{r}
avg_fls <- repro_full %>% 
  group_by(Sp_Code, Population, Treatment) %>% 
  summarise(avg_fl = mean(avg_fl_mass),
            stdev = sd(avg_fl_mass))
```

## Graph RE by species

```{r}
# Remove AVEFAT
repro_full <- repro_full[-c(which(repro_full$Sp_Code == "AVEFAT")),]

ggplot(repro_full, aes(x = Scientific_Name, y = RE)) +
  geom_boxplot() +
  # geom_dotplot(binaxis = "y", stackdir = "center", dotsize = 0.5) + 
  theme_bw() +
  labs(x = "Species",
       y = "Reproductive Effort (R/R+V)") +
  theme(axis.text.x = element_text(size=9, angle=45, hjust = 1))

one.way <- aov(RE ~ Sp_Code, data = repro_full)
summary(one.way)
TukeyHSD(one.way)

ggsave("RE_prelim_plot.jpg")
```
## Graph Allometry by Species

Here, make a graph with vegetative biomass on the x-axis and reproductive biomass on the y-axis. Have each species be a different color with raw points on the graph, faded in color. Add a line for each species.

Will need to go back and test nad remove outliers

```{r}
# Remove AVEFAT
repro_full <- repro_full[-c(which(repro_full$Sp_Code == "AVEFAT")),]
head(repro_full)

ggplot(repro_full, aes(x = Veg_Mass, y = total_fl_mass, color = Sp_Code)) +
  geom_point(aes(x = Veg_Mass, y = total_fl_mass, color = Sp_Code)) +
  geom_smooth(method = "lm", fill = NA) +
  theme_bw() +
  labs(x = "Vegetative Biomass",
       y = "Reproductive Biomass") +
  theme(axis.text.x = element_text(size=9, angle=45, hjust = 1))

# Consider log -scaling to make more digestible

one.way <- aov(RE ~ Sp_Code, data = repro_full)
summary(one.way)
TukeyHSD(one.way)

ggsave("RE_prelim_plot.jpg")
```


## Graph BROHOR, BRODIA, AVEBAR by population

```{r}
level_order <- c('ANGELO', 'MCL', 'BORR','SEDG','WWP')

repro_AVEBAR <- repro_full[which(repro_full$Sp_Code == "AVEBAR"),]

ggplot(repro_AVEBAR, aes(x = factor(Population, level = level_order), y = RE)) +
  geom_boxplot() +
  # geom_dotplot(binaxis = "y", stackdir = "center", dotsize = 0.5) + 
  theme_bw() +
  labs(title = "Avena barbata",
    x = "Provenance",
       y = "Reproductive Effort (R/R+V)") +
  theme(axis.text.x = element_text(face="bold", 
                           size=10, angle=45, hjust = 1))

one.way <- aov(RE ~ Population, data = repro_AVEBAR)
summary(one.way)
TukeyHSD(one.way)

ggsave("RE_AVEBAR_prelim.jpg")

repro_BRODIA <- repro_full[which(repro_full$Sp_Code == "BRODIA"),]

ggplot(repro_BRODIA, aes(x = factor(Population, level = level_order), y = RE)) +
  geom_boxplot() +
  # geom_dotplot(binaxis = "y", stackdir = "center", dotsize = 0.5) + 
  theme_bw() +
  labs(title = "Bromus diandrus",
    x = "Provenance",
       y = "Reproductive Effort (R/R+V)") +
  theme(axis.text.x = element_text(face="bold", 
                           size=10, angle=45, hjust = 1))
one.way <- aov(RE ~ Population, data = repro_BRODIA)
summary(one.way)
TukeyHSD(one.way)

ggsave("RE_BRODIA_prelim.jpg")

repro_BROHOR <- repro_full[which(repro_full$Sp_Code == "BROHOR"),]

ggplot(repro_BROHOR, aes(x = factor(Population, level = level_order), y = RE)) +
  geom_boxplot() +
  # geom_dotplot(binaxis = "y", stackdir = "center", dotsize = 0.5) + 
  theme_bw() +
  labs(title = "Bromus hordeaceus",
    x = "Provenance",
       y = "Reproductive Effort (R/R+V)") +
  theme(axis.text.x = element_text(face="bold", 
                           size=10, angle=45, hjust = 1))
one.way <- aov(RE ~ Population, data = repro_BROHOR)
summary(one.way)
TukeyHSD(one.way)

ggsave("RE_BROHOR_prelim.jpg")
```

## Relative Growth Rate

```{r}
rgr <- read_csv("Relative Growth Rate 2023 copy.csv")
str(rgr)
summary(rgr)
head(rgr)

```

## Photosynthetic Rate

```{r}



```

## Leaf Mass Area

## Leaf Area

## WUE

## Height

## Leaf Nitrogen

## Date of first flower

## Mid season biomass partial

## Root biomass partial

## Root:shoot ratio partial

## Root diameter partial

## Specific root length partial

## Root nitrogen partial
