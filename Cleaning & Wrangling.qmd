---
title: "Cleaning & Wrangling"
author: "Brooke Wainwright"
format: html
editor: visual
---

## Background

These data come from a common garden drought experiment in Davis, California investigating the functional trait strategies of California grassland plants from five different grassland communities spanning California's latitudinal precipitation gradient. There 10-12 species per community or provenance, each provenance has 16 plots (8 drought, 8 control) across 10 shelters (5 drought, 5 control). In 2022-2023, we focused on collecting whole plant traits, including reproductive investment. This study focuses on how these traits relate to reproductive investment depending on native status, growth habit or provenance. This document will clean and wrangle the many datasets and images associated with this study.

## Traits & Objectives

-   Reproductive allocation
-   End of Season biomass
-   Relative Growth Rate
-   Photosynthetic Rate
-   Leaf Mass Area
-   Leaf Area
-   WUE Height
-   Leaf Nitrogen
-   Date of first flower
-   Mid season biomass partial
-   Root biomass partial
-   Root:shoot ratio partial
-   Root diameter partial
-   Specific root length partial
-   Root nitrogen partial

Bring in, explore, clean, rectify outliers, organize each trait or group of traits and export as "...\_CLEAN"

## To-do list
- Check for effects of drought treatment
- Add in aridity index
- Check assumptions for models
- Fix Map orientation
- Add 3-part rating (native, non-native, invasive)

## Setup

```{r}
#| message: false
#| warning: false
#| echo: false

library(colorspace)
library(readr)
library(plyr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(viridis)
library(lme4)
library(LeafArea)
library(mapdata)
library(maps)
library(terra)
library(broom)
library(tidyverse)
library(sf)
library(geodata)
library(terra)
library(tigris)
library(ggnewscale)
library(scatterpie)
library(lmtest)
library(car)
library(bbmle)
library(cropgrowdays)
library(emmeans)
```

## CA Map and Plant Comp

Make a map of California with the inside of the boundary as a heat map of an aridity index. Then add five pie charts of plant composition.

Precip data from WorlClim

```{r}

# ----- climate data -----
ppt <- worldclim_global(var = "prec", res = 2.5, path = "data/")
ppt_annual <- sum(ppt)

# ----- California boundary -----
ca <- states(cb = TRUE) |> subset(NAME == "California")
ca_vect <- vect(ca)

# ----- crop & mask -----
ppt_ca <- crop(ppt_annual, ca_vect)
ppt_ca <- mask(ppt_ca, ca_vect)

# ----- convert to df -----
ppt_df <- as.data.frame(ppt_ca, xy = TRUE)
names(ppt_df) <- c("x", "y", "ppt")

# ----- plot -----
ggplot(ppt_df) +
  geom_raster(aes(x = x, y = y, fill = ppt)) +
  geom_sf(data = ca, fill = NA, color = "black") +
  scale_fill_viridis_c(name = "Annual precip (mm)") +
  coord_sf() +
  labs(title = "Annual Precipitation in California (WorldClim v2.1)") +
  theme_minimal()

rm(ppt_ca, ppt, ppt_annual)
```


```{r}
## Need the pie chart data to have the following columns: ID, Lat, Long, Sp1 proportion, Sp2 proportion, etc.

# so we need to pivot wider the dataset and average across ten plots and add coordaintes for each site then use mapPies function
plant_comp <- read_csv("USDA_Site Composition.csv")
str(plant_comp)

# First average across ten plots
comp_sum <- plant_comp %>%
  filter(!Species == "Grass") %>% 
  group_by(Site, Species) %>% 
  summarise(avg_cov = mean(Percent_Cover, na.rm = TRUE))

# get rid of bare ground, rock, and litter
comp_sum <- comp_sum %>%
  filter(!Species %in% c("Litter","Rock","Bare ground")) %>% 
  group_by(Site) %>% 
  arrange(desc(avg_cov), .by_group = TRUE)

PlList_2023 <- read_csv("USDA Drought Project 2023 Plant List.csv")
pl_list <- PlList_2023 %>% 
  select(Site, Species)

comp_reduced <- left_join(pl_list, comp_sum, by=join_by(Site, Species))

comp_reduced$prop_cov <- comp_reduced$avg_cov/100

comp_reduced <- comp_reduced %>% 
  group_by(Site) %>% 
  mutate(prop_total = sum(prop_cov))

comp_reduced$prop_adj <- comp_reduced$prop_cov/comp_reduced$prop_total

comp_wide <- comp_reduced %>% 
  select(Site,
         Species,
         prop_adj) %>% 
  pivot_wider(names_from = Species,
              values_from = prop_adj)

## add lat and long columns
comp_wide$lat <- c(39.75141,37.37914,38.87508,34.70243,34.91771)
comp_wide$long <- c(-123.6302,-121.72841,-122.42114,-120.0545,-119.16882)
comp_wide$long_move <- comp_wide$long - 2
comp_wide$lat_move<- comp_wide$lat
comp_wide$lat_move[4] <- comp_wide$lat[4] + 1
comp_wide$lat_move[5] <- comp_wide$lat[5] - 1
comp_wide$lat_move[1] <- comp_wide$lat[1] + 1
comp_wide$lat_move[2] <- comp_wide$lat[2] - 0.5
comp_wide$long_move[3] <- comp_wide$long[3] - 2.5
comp_wide$lat_move[3] <- comp_wide$lat[3] - 0.25
comp_wide$long_move[4] <- comp_wide$long[4] - 3.5
comp_wide$lat_move[4] <- comp_wide$lat[4] + 0.1
comp_wide$long_move[5] <- comp_wide$long[5] - 2.5
comp_wide$lat_move[5] <- comp_wide$lat[5] - 1.5
#comp_wide$long_move[1] <- comp_wide$long[1] + 0.2
comp_wide

comp_wide[is.na(comp_wide)] <- 0
colors <- rainbow_hcl(37)


# ----- plot -----
ggplot() +
  geom_raster(data = ppt_df, aes(x = x, y = y, fill = ppt)) +
    scale_fill_viridis_c(name = "Annual precip (mm)") +
  new_scale_fill() +
 geom_segment(
  data = comp_wide,
  aes(x = long, y = lat, xend = long_move, yend = lat_move),
  color = "black", linewidth = 0.75
) +
   geom_scatterpie(
    data = comp_wide,
    aes(long_move, lat_move, r = 1),
    cols = c("Acmispon parviflorus"
             ,"Aira caryophyllea"
             ,"Bromus diandrus"
             ,"Bromus hordeaceus"
             ,"Clarkia purpurea"
             ,"Danthonia californica"
             ,"Daucus pusillus"
             ,"Eschscholzia californica"
             ,"Galium parisiense"
             ,"Hypochaeris glabra"
             ,"Madia gracilis"
             ,"Sanicula bipinnatifida"
             ,"Avena barbata"
             ,"Erodium botrys"
             ,"Geranium dissectum"
             ,"Lupinus bicolor"
             ,"Torilis arvensis"
             ,"Trifolium hirtum"
             ,"Vicia sativa"
             ,"Bromus madritensis"
             ,"Elymus caput-medusae"
             ,"Holocarpha virgata"
             ,"Micropus californicus"
             ,"Plantago erecta"
             ,"Avena fatua"
             ,"Calandrinia menziesii"
             ,"Centaurea melitensis"
             ,"Corethrogyne filaginifolia"
             ,"Erodium cicutarium"
             ,"Stipa pulchra"
             ,"Amsinckia menziesii"
             ,"Bromus arenarius"
             ,"Caulanthus coulteri"
             ,"Lupinus microcarpus"
             ,"Lupinus succulentus"
             ,"Phacelia tanacetifolia"
             ,"Mirabilis multiflora")   # your pie-slice variables
  ) +
scale_fill_manual(
    name = "Species",
    values = c(
             "Acmispon parviflorus" = colors[1]
             ,"Aira caryophyllea" = colors[2]
             ,"Bromus diandrus" = colors[3]
             ,"Bromus hordeaceus" = colors[4]
             ,"Clarkia purpurea" = colors[5]
             ,"Danthonia californica" = colors[6]
             ,"Daucus pusillus" = colors[7]
             ,"Eschscholzia californica" = colors[8]
             ,"Galium parisiense" = colors[9]
             ,"Hypochaeris glabra" = colors[10]
             ,"Madia gracilis" = colors[11]
             ,"Sanicula bipinnatifida" = colors[12]
             ,"Avena barbata" = colors[13]
             ,"Erodium botrys" = colors[14]
             ,"Geranium dissectum" = colors[15]
             ,"Lupinus bicolor" = colors[16]
             ,"Torilis arvensis" = colors[17]
             ,"Trifolium hirtum" = colors[18]
             ,"Vicia sativa" = colors[19]
             ,"Bromus madritensis" = colors[20]
             ,"Elymus caput-medusae" = colors[21]
             ,"Holocarpha virgata" = colors[22]
             ,"Micropus californicus" = colors[23]
             ,"Plantago erecta" = colors[24]
             ,"Avena fatua" = colors[25]
             ,"Calandrinia menziesii" = colors[26]
             ,"Centaurea melitensis" = colors[27]
             ,"Corethrogyne filaginifolia" = colors[28]
             ,"Erodium cicutarium" = colors[29]
             ,"Stipa pulchra" = colors[30]
             ,"Amsinckia menziesii" = colors[31]
             ,"Bromus arenarius" = colors[32]
             ,"Caulanthus coulteri" = colors[33]
             ,"Lupinus microcarpus" = colors[34]
             ,"Lupinus succulentus" = colors[35]
             ,"Phacelia tanacetifolia" = colors[36]
             ,"Mirabilis multiflora" = colors[37]
    )
    , guide = "none"
  ) +
  geom_sf(data = ca, fill = NA, color = "black",linewidth = 0.75) +
  coord_sf(xlim = c(-127, -113), ylim = c(32, 42)) +
  labs(title = "Annual Precipitation in California (WorldClim v2.1)") +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    axis.title = element_blank(),
    legend.position = c(0.925,0.725)
  )  +
  geom_point(data = data.frame(lat = 38.544854, long = -121.784516), 
             aes(x = long, y = lat),
                 color = "red", 
                 size = 4)

ggsave("CA_precip_comp_map.jpg")

rm(comp_sum, comp_reduced)
```

Alignment is off -- need to fix


## Reproductive allocation & End of Season biomass

Read in data, find outliers, fill in missing data

```{r}
#| warning: false
## Read in Data
repro <- read_csv("Reproductive Allocation_2023.csv")
str(repro)
summary(repro)
head(repro)

```

### Clean up and create variables

Remove rows that have NA in the Flower Count row and in the Veg Mass Row. 

```{r}
# Remove individuals with no veg mass and no flower count
repro_narm <- repro %>% 
  drop_na(Flower_Count) %>% 
  drop_na(Veg_Mass)

# Read in plot data
plots <- read_csv("Plot_info copy.csv")
str(plots)
summary(plots)
head(plots)

# Read in species data
spp <- read_csv("Species Codes copy.csv")
unique(spp$Sp_Code)
unique(repro$Species)

# Pull plot code from Plant_ID, first two characters
repro_narm <- repro_narm %>% 
  mutate(Plot = substr(Plant_ID, start = 1, stop = 2))
unique(repro_narm$Plot)

# merge with plots
repro_full <- left_join(repro_narm,plots,by = join_by(Plot))

# Change name for consistency
repro_full$Sp_Code <- repro_full$Species

# merge with species data
repro_full <- left_join(repro_full,spp,by = join_by(Sp_Code))

# clean up dataset and re-order
repro_full <- repro_full %>% 
  select(
    Plant_ID,
    Sp_Code,
    Scientific_Name,
    Native_Status,
    Growth_Habit,
    Perenniality,
    Rating,
    Source,
    Recorder,
    Collection_Date,
    Plot,
    Block,
    Shelter,
    Plot_number,
    Population,
    Treatment,
    Flower_Count,
    Flower_1_g,
    Flower_2_g,
    Flower_3_g,
    Flower_4_g,
    Flower_5_g,
    Flower_6_g,
    Flower_7_g,
    Flower_8_g,
    Flower_9_g,
    Flower_10_g,
    Veg_Mass
  )


# repro_full[which(repro_full$Plant_ID == "G3.AVEFAT.1"),]
# two separate entries, go back and fix manually. Probably additive
# Additive! two flower bags and two veg bags.

# repro_full[which(repro_full$Plant_ID == "F2.BRODIA.1"),]
# was this counted twice?
# Counted twice, go with the heavier veg mass since debris was probably lost

# repro_full[which(repro_full$Plant_ID == "J1.BRODIA.1"),]
# was this counted twice?
# this was counted twice. The 4.01 mass is correct

rm(repro,repro_narm)
```

Now check for outliers
```{r}
# Make a dataset so we can average flower mass per species x population x treatment and then find outliers

repro_outliers_vg <- repro_full %>% 
  group_by(Sp_Code,
           Population) %>% 
  mutate(vg_avg = mean(Veg_Mass, na.rm = TRUE),
        vg_sd = sd(Veg_Mass, na.rm = TRUE)) %>% 
  select(Plant_ID,
         Sp_Code,
         Population,
         Veg_Mass,
         vg_avg,
         vg_sd)

# remove any rows with NAs
repro_outliers_vg <- repro_outliers_vg[complete.cases(repro_outliers_vg),]

# get minimums and maximums using 3 standard deviations
veg_avgs <- repro_outliers_vg %>% 
  mutate(vg_max = vg_avg + 3*vg_sd,
         vg_min = vg_avg - 3*vg_sd)

# do the same for veg mass
vg_outliers <- veg_avgs[which(veg_avgs$Veg_Mass > veg_avgs$vg_max | veg_avgs$Veg_Mass < veg_avgs$vg_min),c("Plant_ID","Sp_Code","Population", "Veg_Mass","vg_avg","vg_sd","vg_min","vg_max")]
# Only 4 and they are just above the maximum, keep

# write_csv(vg_outliers, "vg_outliers.csv")

# now do separately for fls
repro_outliers_fl <- repro_full %>% 
  pivot_longer(cols = c(Flower_1_g, 
                        Flower_2_g, 
                        Flower_3_g,
                        Flower_4_g,
                        Flower_5_g,
                        Flower_6_g,
                        Flower_7_g,
                        Flower_8_g,
                        Flower_9_g,
                        Flower_10_g),
               names_to = "Flower",
               values_to = "Flower_Mass_g") %>% 
  select(Plant_ID,
         Sp_Code,
         Scientific_Name,
         Population,
         Flower,
         Flower_Mass_g,
         Veg_Mass) %>% 
  filter(!is.na(Flower_Mass_g))

# export dataset for intern/undergraduate practice
# write_csv(repro_outliers, "repro_intern.csv")

# Group by spp and population and then find averages and standard deviations
str(repro_outliers_fl)

repro_avgs_fl <- repro_outliers_fl %>% 
  group_by(Sp_Code,
           Population) %>% 
  mutate(fl_avg = mean(Flower_Mass_g, na.rm = TRUE),
            fl_sd = sd(Flower_Mass_g, na.rm = TRUE)) %>% 
  select(Plant_ID,
         Sp_Code,
         Population,
         Flower,
         Flower_Mass_g,
         fl_avg,
         fl_sd)

# remove any rows with NAs
repro_avgs_fl <- repro_avgs_fl[complete.cases(repro_avgs_fl),]

# get minimums and maximums using 3 standard deviations
repro_avgs_fl <- repro_avgs_fl %>% 
  mutate(fl_max = fl_avg + 3*fl_sd,
         fl_min = fl_avg - 3*fl_sd)

# Make a dataframe with rows of observations of flower masses that are either larger than the maximum or smaller than the minimum
fl_outliers <- repro_avgs_fl[which(repro_avgs_fl$Flower_Mass_g > repro_avgs_fl$fl_max | repro_avgs_fl$Flower_Mass_g < repro_avgs_fl$fl_min),c("Plant_ID","Sp_Code","Population", "Flower", "Flower_Mass_g","fl_avg","fl_sd","fl_min","fl_max")]

# make csvs to look deeper
# write_csv(fl_outliers, "fl_outliers.csv")

# find difference between flower mass and maximum
fl_outliers$dif <- fl_outliers$Flower_Mass_g-fl_outliers$fl_max

# how bad is it? anything bigger than 1 standard deviation difference is too big
fl_hi <- fl_outliers[which(fl_outliers$dif >= fl_outliers$fl_sd),]
# flower masses in fl_hi are way too big to include

# Make those flower masses NAs and replace in repro_full

# make repro_full long and then rbind and remove duplicates
fl_hi$Flower_Mass_g <- NA
fl_hi <- fl_hi %>% 
  select(
    Plant_ID,
    Sp_Code,
    Population,
    Flower,
    Flower_Mass_g) %>% 
  mutate(
    ID_no = paste0(Plant_ID,Flower)
  )

# make original dataset long
repro_full_long <- repro_full %>% 
  pivot_longer(cols = c(Flower_1_g, 
                        Flower_2_g, 
                        Flower_3_g,
                        Flower_4_g,
                        Flower_5_g,
                        Flower_6_g,
                        Flower_7_g,
                        Flower_8_g,
                        Flower_9_g,
                        Flower_10_g),
               names_to = "Flower",
               values_to = "Flower_Mass_g") %>% 
  mutate(
    ID_no = paste0(Plant_ID,Flower)
  )

# create list of Plant_ID and flower number combos that need to become NA
nays <- fl_hi$ID_no

# create that dataset of 
repro_long_filt <- repro_full_long %>% 
  filter(ID_no %in% c(nays)) %>% 
  mutate(
    Flower_Mass_g = NA
  )
# 27 outliers converted to NA

# check your work, should return an NA
repro_long_filt$Flower_Mass_g[repro_long_filt$ID_no == sample(nays,1)]

# Now rbind, order, and remove duplicates
# 5620 in repro fill long, and 27 in repro long filt
# should have 5647
repro_fullfilt_long <- rbind(repro_long_filt,repro_full_long)

repro_long <- repro_fullfilt_long[-which(duplicated(repro_fullfilt_long$ID_no)),]

repro_full_2 <- repro_long %>% 
  pivot_wider(id_cols = Plant_ID,
              names_from = Flower,
              values_from = Flower_Mass_g)

# bind with original
repro_full <- repro_full %>% 
  select(
    Plant_ID,
    Sp_Code,
    Scientific_Name,
    Native_Status,
    Growth_Habit,
    Rating,
    Source,
    Recorder,
    Collection_Date,
    Plot,
    Block,
    Shelter,
    Plot_number,
    Population,
    Treatment,
    Flower_Count,
    Veg_Mass
  )

repro_full_3 <- left_join(repro_full_2,repro_full,by=join_by(Plant_ID))

repro_full <- repro_full_3 %>% 
  select(
    Plant_ID,
    Sp_Code,
    Scientific_Name,
    Native_Status,
    Growth_Habit,
    Rating,
    Source,
    Plot,
    Block, 
    Shelter,
    Plot_number,
    Population,
    Treatment,
    Recorder,
    Collection_Date,
    Flower_1_g,
    Flower_2_g,
    Flower_3_g,
    Flower_4_g,
    Flower_5_g,
    Flower_6_g,
    Flower_7_g,
    Flower_8_g,
    Flower_9_g,
    Flower_10_g,
    Flower_Count,
    Veg_Mass
  )

rm(repro_outliers_fl,
   repro_outliers_vg, 
   repro_avgs_fl,
   veg_avgs, 
   fl_outliers, 
   vg_outliers, 
   fl_hi, 
   repro_full_long, 
   nays, 
   repro_long_filt, 
   repro_fullfilt_long, 
   repro_long,
   repro_full_2,
   repro_full_3)
```

Now flower outliers have been removed, veg outliers have been checked.

Now fill in average flower mass for for each Species x population x treatment and fill in for individuals with no flower masses. 

```{r}

# Average flower masses for each individual
firstfl = which(colnames(repro_full)=="Flower_1_g")
lastfl = which(colnames(repro_full)=="Flower_10_g")
repro_full[,c(firstfl:lastfl)]

repro_full$fl_average <- rowMeans(repro_full[,c(firstfl:lastfl)], na.rm = TRUE)

# Find the individuals with no flower mass
no_fls <- repro_full[which(repro_full$fl_average == "NaN"),]

# include everything except fl-Average
firstcol = which(colnames(no_fls)=="Plant_ID")
lastcol = which(colnames(no_fls)=="Veg_Mass")
no_fls <- no_fls[,c(firstcol:lastcol)]

# remove the individuals with no flower masses
repro_full <- repro_full[which(repro_full$fl_average != "NaN"),]

# detach(package:plyr)
# when plyr is loaded after dplyr, group_by doesn't work
avg_fls <- repro_full %>% 
  group_by(Sp_Code, Population, Treatment) %>% 
  summarise(fl_average = mean(fl_average, na.rm = TRUE))

# mast avg fls onto no_fls and then re-merge no-fls with larger dataset
rep_fls <- left_join(no_fls,avg_fls,by=join_by(Sp_Code,Population,Treatment))
repro_fill <- rbind(rep_fls,repro_full)

# check your work
repro_fill[which(is.na(repro_fill$fl_average)),]
# There's one without averages to fill in? Calmen in E6...investigate

repro_fill$total_fl_mass <- repro_fill$Flower_Count*repro_fill$fl_average

# There's an entry for ESCCAL which hasn't been done yet -- look into
# Later you can remove any species with only one entry

rm(repro_full,
   no_fls,
   avg_fls)

```
Now remove species with low data, less than three observations

```{r}
unique(repro_fill$Sp_Code)

# Who are the species with low n?
summary <- repro_fill %>% 
  group_by(Sp_Code) %>% 
  summarise(n = n()) %>% 
  filter(n < 3)
# ACMPAR, CAUCOU, ESCCAL, LUPSUC

Sp_List_small <- summary$Sp_Code

# Remove species with less than 3 entries
repro_fill_hi_n <- repro_fill[-(which(repro_fill$Sp_Code %in% c(Sp_List_small))),]
unique(repro_fill_hi_n$Sp_Code)

summary(repro_fill_hi_n)

repro_fill_hi_n_narm <- repro_fill_hi_n[-(which(repro_fill_hi_n$total_fl_mass %in% c(NA, -Inf))),]

repro_fill_hi_n_narm_1 <- repro_fill_hi_n_narm

# Lastly add in precipitation
precip <- read_csv("Site_Precip.csv")
repro_fill_hi_n_narm <- left_join(repro_fill_hi_n_narm_1,precip, by=join_by("Population"))

rm(summary,
   Sp_List_small,
   repro_fill,
   repro_fill_hi_n,
   precip,
   repro_fill_hi_n_narm_1
   )
```

Find and add in SPEI

```{r}
#| eval: false
install.packages("devtools")
require(devtools)
devtools::install_github('seschaub/getSpei')
require(getSpei)

workdir <- getwd()
setwd(workdir)

# create data frame:
Population  <- c("ANGELO", "MCL", "BORR","SEDG","WWP")
longitude    <- c(-123.6302, -121.72841, -122.42114, -120.0545, -119.16882)
latitude     <- c(39.75141, 37.37914, 38.87508, 34.70243, 34.91771)
locations_df <- data.frame(Population, longitude, latitude)

# specify arguments and run function:
d1 <- spec_spei(spei_files = "spei48", start_y = 2015, end_y = 2015, 
                locations = locations_df)

write.csv(d1, "SPEI_Pop.csv")
```

```{r}
spei <- read_csv("SPEI_Pop.csv")
spei <- spei %>% 
  filter(month > 2 & month < 6)


spei_avg <- spei %>% 
  group_by(location_id) %>% 
  summarise(spei_avg = mean(spei48)) %>% 
  mutate(Population = location_id)

spei_avg <- spei_avg[,c("Population","spei_avg")]

repro_fill_hi_n_narm_1 <- left_join(repro_fill_hi_n_narm,spei_avg, by=join_by("Population"))

repro_fill_hi_n_narm <- repro_fill_hi_n_narm_1

repro_fill_hi_n_narm$Veg_Mass_ln <- log(repro_fill_hi_n_narm$Veg_Mass)
repro_fill_hi_n_narm$total_fl_mass_ln <- log(repro_fill_hi_n_narm$total_fl_mass)

repro_fill_hi_n_narm <- repro_fill_hi_n_narm[-(which(repro_fill_hi_n_narm$total_fl_mass_ln %in% c(NA, -Inf))),]

# Create ratio of fl to v
repro_fill_hi_n_narm$VR <- repro_fill_hi_n_narm$total_fl_mass_ln/repro_fill_hi_n_narm$Veg_Mass_ln

repro_fill_hi_n_narm <- repro_fill_hi_n_narm %>% 
  mutate(rating.n = (
    case_when(
      Rating == "Native" ~ 1
      , Rating == "Non-native" ~ 2
      , Rating == "Limited" ~ 3
      , Rating == "Moderate" ~ 4
      , Rating == "High" ~ 5
    )
  ))

```



We did it! Now graph and analyze.

### Graph & Analyze

Here, make a graph with vegetative biomass on the x-axis and reproductive biomass on the y-axis. Have each species be a different color with raw points on the graph, faded in color. Add a line for each species.

Make everything log scale

#### Line: Species slopes
```{r}


ggplot(repro_fill_hi_n_narm, aes(x = Veg_Mass_ln, y = total_fl_mass_ln, color = Scientific_Name 
# , linetype = Native_Status
)) +
  geom_abline(intercept = 0, slope = 1) +
  #geom_point(aes(x = Veg_Mass_ln, y = total_fl_mass_ln, color = Species)) +
  geom_smooth(method = "lm", fill = NA, linewidth = 1) +
  # scale_color_viridis(discrete=TRUE) +
  theme_bw() +
  scale_linetype_manual(values = c("Native" = "dashed", "Non-native" = "solid")) +
  labs(x = "ln(Vegetative Biomass (g))",
       y = "ln(Reproductive Biomass (g))") +
  theme(axis.text.x = element_text(size=9))

# Consider log -scaling to make more digestible

ggsave("Allom_log_plot.jpg")

# Can I put the slope next to each species name
# test to see if slopes are significantly different from 0 and form each other

anova(lm(total_fl_mass_ln ~ Veg_Mass_ln*Scientific_Name, data = repro_fill_hi_n_narm))

mod <- lmList(total_fl_mass_ln ~ Veg_Mass_ln | Scientific_Name, data = repro_fill_hi_n_narm)

# Make plot larger/wider
mod <- as.data.frame(summary(mod)$coefficients)

sp_list <- sort(unique(repro_fill_hi_n_narm$Scientific_Name))
mod$Scientific_Name <- sort(unique(repro_fill_hi_n_narm$Scientific_Name))
new_spp <- left_join(spp,mod,by=join_by("Scientific_Name")) %>%
  select(
    Scientific_Name,
    Estimate.Veg_Mass_ln
  )

repro_slopes <- left_join(repro_fill_hi_n_narm,new_spp, by=join_by("Scientific_Name")) %>% 
  mutate(
    Species = paste0(Scientific_Name,
                     " ",
                     substr(Estimate.Veg_Mass_ln,1,4)
  )
)

ggplot(repro_slopes, aes(x = Veg_Mass_ln, y = total_fl_mass_ln, color = Species 
# , linetype = Native_Status
)) +
  geom_abline(intercept = 0, slope = 1) +
  #geom_point(aes(x = Veg_Mass_ln, y = total_fl_mass_ln, color = Species)) +
  geom_smooth(method = "lm", fill = NA, linewidth = 0.5) +
  # scale_color_viridis(discrete=TRUE) +
  theme_bw() +
  scale_linetype_manual(values = c("Native" = "dashed", "Non-native" = "solid")) +
  labs(x = "ln(Vegetative Biomass (g))",
       y = "ln(Reproductive Biomass (g))") +
  theme(axis.text.x = element_text(size=9),
        legend.key.size = unit(0.5, "cm"),
        legend.text= element_text(size = 9),
        legend.title = element_text(size = 9),
        legend.position = "bottom")


ggsave("Allom_log_plot_slopes.jpg", height=9, width = 9)

# These aren't actually the correct slopes, the correct slopes come from emtrends


```


Analysis of lines different than 1:1

```{r}
#| eval: false
anova(lm(total_fl_mass_ln ~ Veg_Mass_ln*Scientific_Name, data = repro_fill_hi_n_narm))

mod <- lm(total_fl_mass_ln ~ Veg_Mass_ln * Scientific_Name, 
          data = repro_fill_hi_n_narm)

slopes <- emtrends(mod, ~ Scientific_Name, var = "Veg_Mass_ln")
slopes

test_slopes_vs1 <- test(slopes, null = 1)
test_slopes_vs1[which(test_slopes_vs1$p.value<0.05),]


pairs(slopes)
# anova(lm(total_fl_mass_ln ~ Veg_Mass_ln*Sp_Code, data = repro_fill_hi_n))

options(max.print=2000)
pairs(slopes, adjust = "tukey")

repro_dif <- repro_slopes %>% 
  filter(
    Scientific_Name %in% c("Amsinckia menziesii","Avena barbata","Bromus diandrus","Bromus hordeaceaus"))

ggplot(repro_dif, aes(x = Veg_Mass_ln, y = total_fl_mass_ln, color = Species 
# , linetype = Native_Status
)) +
  geom_abline(intercept = 0, slope = 1) +
  #geom_point(aes(x = Veg_Mass_ln, y = total_fl_mass_ln, color = Species)) +
  geom_smooth(method = "lm", fill = NA, size = 1) +
  # scale_color_viridis(discrete=TRUE) +
  theme_bw() +
  scale_linetype_manual(values = c("Native" = "dashed", "Non-native" = "solid")) +
  labs(x = "ln(Vegetative Biomass (g))",
       y = "ln(Reproductive Biomass (g))") +
  theme(axis.text.x = element_text(size=15),
        legend.text= element_text(size = 15),
        legend.title = element_text(size = 15),
        legend.position = "bottom")


ggsave("Allom_log_plot_slopes_1.jpg", height=9, width = 15)

```
It's interesting that the three most widespread species are significant and low. And the arguable invasive native is the other significant.

#### Bar: Species slopes

```{r}
slopes <- emtrends(mod, ~ Scientific_Name, var = "Veg_Mass_ln")
slopes

slopes.df <- summary(slopes) %>% 
  arrange(desc(Veg_Mass_ln.trend))

test_slopes_vs1 <- test(slopes, null = 1)
test_slopes_vs1[which(test_slopes_vs1$p.value<0.05),]

level_order <- unique(as.factor(slopes.df$Scientific_Name))


# Graph a bar plot of each species in order of slope with standard error bars and line at 1

#("ANGELO" = "#440154FF", "MCL" = "#3B528BFF", "BORR" = "#21908CFF", "SEDG" = "#5DC863FF", "WWP" = "#FDE725FF")) + 

# Make species names italic and 45 degrees
# Maybe make bar colors if significant

sigs <- test_slopes_vs1[which(test_slopes_vs1$p.value<0.05),1]

slopes.df$columnColor <- "N.S."

slopes.df$columnColor[which(slopes.df$Scientific_Name == sigs[1])] <- "p-value < 0.05"

slopes.df$columnColor[which(slopes.df$Scientific_Name == sigs[2])] <- "p-value < 0.05"

slopes.df$columnColor[which(slopes.df$Scientific_Name == sigs[3])] <- "p-value < 0.05"

slopes.df$columnColor[which(slopes.df$Scientific_Name == sigs[4])] <- "p-value < 0.05"

ggplot(slopes.df, aes(x = factor(Scientific_Name, level=c(level_order)), y = Veg_Mass_ln.trend
                       , fill = columnColor
                      )) + 
  geom_bar(position = position_dodge(), stat = "identity") +
  geom_hline(yintercept = 1, linetype = "dashed") +
  geom_errorbar(aes(ymin=Veg_Mass_ln.trend-SE, ymax=Veg_Mass_ln.trend+SE), width=0.3, colour="#FDE725FF", alpha=0.9, size=1.3, position = position_dodge(0.9)) +
  theme_classic() +
  scale_fill_manual(values = c("N.S." = "#21908CFF", "p-value < 0.05" = "#440154FF")) +
  theme(
    axis.text.x = element_text(face = "italic", angle = 45, vjust = 1, hjust = 1),
    legend.position = c(0.75, 0.95),
    #legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.margin = margin(6, 6, 6, 6),
    plot.margin = unit(c(0.25,0.25,0.25,0.75), "cm")
  ) + 
  guides(fill=guide_legend(ncol=2)) +
  labs(x = "Species",
       y = "VR Slope",
       fill = "")

ggsave("slopes_spp.jpg")


```

#### Bar: Native

```{r}
anova(lm(total_fl_mass_ln ~ Veg_Mass_ln*Native_Status, data = repro_fill_hi_n_narm))

mod <- lm(total_fl_mass_ln ~ Veg_Mass_ln * Native_Status, 
          data = repro_fill_hi_n_narm)


slopes <- emtrends(mod, ~ Native_Status, var = "Veg_Mass_ln")
slopes

slopes.df <- summary(slopes) %>% 
  arrange(desc(Veg_Mass_ln.trend))

ggplot(slopes.df, aes(x = Native_Status, y = Veg_Mass_ln.trend
                      )) + 
  geom_bar(position = position_dodge(), stat = "identity", fill = "#21908CFF") +
  geom_hline(yintercept = 1, linetype = "dashed") +
  geom_errorbar(aes(ymin=Veg_Mass_ln.trend-SE, ymax=Veg_Mass_ln.trend+SE), width=0.3, colour="#FDE725FF", alpha=0.9, size=1.3, position = position_dodge(0.9)) +
  theme_classic() +
  labs(x = "Native Status",
       y = "VR Slope",
       fill = "")

ggsave("slopes_native.jpg")

```

#### Bar: Rating

```{r}
anova(lm(total_fl_mass_ln ~ Veg_Mass_ln*Rating, data = repro_fill_hi_n_narm))

mod <- lm(total_fl_mass_ln ~ Veg_Mass_ln * Rating, 
          data = repro_fill_hi_n_narm)


slopes <- emtrends(mod, ~ Rating, var = "Veg_Mass_ln")
slopes

slopes.df <- summary(slopes)

ggplot(slopes.df, aes(x = Rating, y = Veg_Mass_ln.trend
                      )) + 
  geom_bar(position = position_dodge(), stat = "identity", fill = "#21908CFF") +
  geom_hline(yintercept = 1, linetype = "dashed") +
  geom_errorbar(aes(ymin=Veg_Mass_ln.trend-SE, ymax=Veg_Mass_ln.trend+SE), width=0.3, colour="#FDE725FF", alpha=0.9, size=1.3, position = position_dodge(0.9)) +
  theme_classic() +
  labs(x = "Native Status",
       y = "VR Slope",
       fill = "")

ggsave("slopes_rating.jpg")

```

#### Bar: Growth

```{r}
anova(lm(total_fl_mass_ln ~ Veg_Mass_ln*Growth_Habit, data = repro_fill_hi_n_narm))

mod <- lm(total_fl_mass_ln ~ Veg_Mass_ln * Growth_Habit, 
          data = repro_fill_hi_n_narm)


slopes <- emtrends(mod, ~ Growth_Habit, var = "Veg_Mass_ln")
slopes

slopes.df <- summary(slopes)

ggplot(slopes.df, aes(x = Growth_Habit, y = Veg_Mass_ln.trend
                      )) + 
  geom_bar(position = position_dodge(), stat = "identity", fill = "#21908CFF") +
  geom_hline(yintercept = 1, linetype = "dashed") +
  geom_errorbar(aes(ymin=Veg_Mass_ln.trend-SE, ymax=Veg_Mass_ln.trend+SE), width=0.3, colour="#FDE725FF", alpha=0.9, size=1.3, position = position_dodge(0.9)) +
  theme_classic() +
  labs(x = "Growth Habit",
       y = "VR Slope",
       fill = "")

ggsave("slopes_growth.jpg")

```

#### Bar: GrowthxNative 

```{r}
anova(lm(total_fl_mass_ln ~ Veg_Mass_ln*Growth_Habit*Native_Status, data = repro_fill_hi_n_narm))

mod <- lm(total_fl_mass_ln ~ Veg_Mass_ln * Growth_Habit * Native_Status, 
          data = repro_fill_hi_n_narm)


slopes <- emtrends(mod, ~ Growth_Habit*Native_Status, var = "Veg_Mass_ln")
slopes

slopes.df <- summary(slopes)

ggplot(slopes.df, aes(x = Growth_Habit, y = Veg_Mass_ln.trend,
                      fill = Native_Status
                      )) + 
  geom_bar(position = position_dodge(), stat = "identity") +
  geom_hline(yintercept = 1, linetype = "dashed") +
  geom_errorbar(aes(ymin=Veg_Mass_ln.trend-SE, ymax=Veg_Mass_ln.trend+SE), width=0.3, colour="#FDE725FF", alpha=0.9, size=1.3, position = position_dodge(0.9)) +
  theme_classic() +
  scale_fill_manual(values = c("Native" = "#440154FF", "Non-native" = "#21908CFF")) +
  labs(x = "Growth Habit",
       y = "VR Slope",
       fill = "")

ggsave("slopes_growthxnative.jpg")

```

#### Bar: GrowthxRating

```{r}
anova(lm(total_fl_mass_ln ~ Veg_Mass_ln*Growth_Habit*Rating, data = repro_fill_hi_n_narm))

mod <- lm(total_fl_mass_ln ~ Veg_Mass_ln * Growth_Habit * Rating, 
          data = repro_fill_hi_n_narm)


slopes <- emtrends(mod, ~ Growth_Habit*Rating, var = "Veg_Mass_ln")
slopes

slopes.df <- summary(slopes)

ggplot(slopes.df, aes(x = Growth_Habit, y = Veg_Mass_ln.trend,
                      fill = Rating
                      )) + 
  geom_bar(position = position_dodge(), stat = "identity") +
  geom_hline(yintercept = 1, linetype = "dashed") +
  geom_errorbar(aes(ymin=Veg_Mass_ln.trend-SE, ymax=Veg_Mass_ln.trend+SE), width=0.3, colour="#FDE725FF", alpha=0.9, size=1.3, position = position_dodge(0.9)) +
  theme_classic() +
  scale_fill_manual(values = c("Native" = "#440154FF", "Non-native" = "#3B528BFF", "Limited" = "#21908CFF", "Moderate" = "#5DC863FF", "High" = "#FDE725FF")) +
  labs(x = "Growth Habit",
       y = "VR Slope",
       fill = "")

ggsave("slopes_growthxrating.jpg")

```

#### Bar: Population

```{r}

repro_fill_hi_n_narm$Population <- factor(repro_fill_hi_n_narm$Population, levels = c("ANGELO", "MCL", "BORR","SEDG","WWP"))

anova(lm(total_fl_mass_ln ~ Veg_Mass_ln*Population, data = repro_fill_hi_n_narm))

mod <- lm(total_fl_mass_ln ~ Veg_Mass_ln * Population, 
          data = repro_fill_hi_n_narm)


slopes <- emtrends(mod, ~ Population, var = "Veg_Mass_ln")
slopes

slopes.df <- summary(slopes)

ggplot(slopes.df, aes(x = Population, y = Veg_Mass_ln.trend,
                      )) + 
  geom_bar(position = position_dodge(), stat = "identity") +
  geom_hline(yintercept = 1, linetype = "dashed") +
  geom_errorbar(aes(ymin=Veg_Mass_ln.trend-SE, ymax=Veg_Mass_ln.trend+SE), width=0.3, colour='black', alpha=0.9, size=1.3, position = position_dodge(0.9)) +
  theme_classic() +
  scale_fill_manual(values = c("ANGELO" = "#440154FF", "MCL" = "#3B528BFF", "BORR" = "#21908CFF", "SEDG" = "#5DC863FF", "WWP" = "#FDE725FF")) +
  labs(x = "Population",
       y = "VR Slope",
       fill = "")

ggsave("slopes_population.jpg")

```

#### Bar: PopxNative

```{r}
anova(lm(total_fl_mass_ln ~ Veg_Mass_ln*Population*Native_Status, data = repro_fill_hi_n_narm))

mod <- lm(total_fl_mass_ln ~ Veg_Mass_ln * Population * Native_Status, 
          data = repro_fill_hi_n_narm)


slopes <- emtrends(mod, ~ Population*Native_Status, var = "Veg_Mass_ln")
slopes

slopes.df <- summary(slopes)

ggplot(slopes.df, aes(x = Population, y = Veg_Mass_ln.trend,
                      fill = Native_Status
                      )) + 
  geom_bar(position = position_dodge(), stat = "identity") +
  geom_hline(yintercept = 1, linetype = "dashed") +
  geom_errorbar(aes(ymin=Veg_Mass_ln.trend-SE, ymax=Veg_Mass_ln.trend+SE), width=0.3, colour="#FDE725FF", alpha=0.9, size=1.3, position = position_dodge(0.9)) +
  theme_classic() +
  scale_fill_manual(values = c("Native" = "#440154FF", "Non-native" = "#21908CFF")) +
  labs(x = "Population",
       y = "VR Slope",
       fill = "")

ggsave("slopes_popxnative.jpg")

```

#### Bar: PopxRating

```{r}
anova(lm(total_fl_mass_ln ~ Veg_Mass_ln*Population*Rating, data = repro_fill_hi_n_narm))

mod <- lm(total_fl_mass_ln ~ Veg_Mass_ln*Population*Rating, 
          data = repro_fill_hi_n_narm)


slopes <- emtrends(mod, ~ Population*Rating, var = "Veg_Mass_ln")
slopes

slopes.df <- summary(slopes)

ggplot(slopes.df, aes(x = Population, y = Veg_Mass_ln.trend,
                      fill = Rating
                      )) + 
  geom_bar(position = position_dodge(), stat = "identity") +
  geom_hline(yintercept = 1, linetype = "dashed") +
  geom_errorbar(aes(ymin=Veg_Mass_ln.trend-SE, ymax=Veg_Mass_ln.trend+SE), width=0.3, colour="#FDE725FF", alpha=0.9, size=1.3, position = position_dodge(0.9)) +
  theme_classic() +
  scale_fill_manual(values = c("Native" = "#440154FF", "Non-native" = "#3B528BFF", "Limited" = "#21908CFF", "Moderate" = "#5DC863FF", "High" = "#FDE725FF")) +
  labs(x = "Population",
       y = "VR Slope",
       fill = "")

ggsave("slopes_popxrating.jpg")

```

#### Bar: PopxGrowth

```{r}
anova(lm(total_fl_mass_ln ~ Veg_Mass_ln*Population*Growth_Habit, data = repro_fill_hi_n_narm))

mod <- lm(total_fl_mass_ln ~ Veg_Mass_ln * Population * Growth_Habit, 
          data = repro_fill_hi_n_narm)


slopes <- emtrends(mod, ~ Population*Growth_Habit, var = "Veg_Mass_ln")
slopes

slopes.df <- summary(slopes)

ggplot(slopes.df, aes(x = Population, y = Veg_Mass_ln.trend,
                      fill = Growth_Habit
                      )) + 
  geom_bar(position = position_dodge(), stat = "identity") +
  geom_hline(yintercept = 1, linetype = "dashed") +
  geom_errorbar(aes(ymin=Veg_Mass_ln.trend-SE, ymax=Veg_Mass_ln.trend+SE), width=0.3, colour="#FDE725FF", alpha=0.9, size=1.3, position = position_dodge(0.9)) +
  theme_classic() +
  scale_fill_manual(values = c("Forb" = "#440154FF", "Grass" = "#21908CFF")) +
  labs(x = "Population",
       y = "VR Slope",
       fill = "")

ggsave("slopes_popxgrowth.jpg")

```

#### Model: VR
Model looking at what creates the ratio of log r and log v. Use species as random effect, and use that to determine best graph

```{r}
str(repro_fill_hi_n_narm)

# Create ratio of fl to v
repro_fill_hi_n_narm$VR <- repro_fill_hi_n_narm$total_fl_mass_ln/repro_fill_hi_n_narm$Veg_Mass_ln

repro_fill_hi_n_narm <- repro_fill_hi_n_narm %>% 
  mutate(rating.n = (
    case_when(
      Rating == "Native" ~ 1
      , Rating == "Non-native" ~ 2
      , Rating == "Limited" ~ 3
      , Rating == "Moderate" ~ 4
      , Rating == "High" ~ 5
    )
  ))

m0 <- glm(VR ~ 1, family = gaussian, data = repro_fill_hi_n_narm)

m1 <- glmer(VR ~ 1 + (1|Scientific_Name), family = gaussian, data = repro_fill_hi_n_narm)

m2 <- glmer(VR ~ 1 + (1|Block/Shelter/Plot), family = gaussian, data = repro_fill_hi_n_narm)

m3 <- glmer(VR ~ 1 + (1|Block) + (1|Treatment), family = gaussian, data = repro_fill_hi_n_narm)

m4 <- glmer(VR ~ 1 + (1|Block/Shelter/Plot) + (1|Scientific_Name), family = gaussian, data = repro_fill_hi_n_narm)

m5 <- glmer(VR ~ 1 + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_fill_hi_n_narm)

m6 <- glmer(VR ~ 1 + (1|Block) + (1|Scientific_Name), family = gaussian, data = repro_fill_hi_n_narm)

ICtab(m0,m1,m2,m3,m4,m5,m6)

m5 <- glmer(VR ~ 1 + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_fill_hi_n_narm)

m_native <- glmer(VR ~ Native_Status + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_fill_hi_n_narm)

m_rating <- glmer(VR ~ Rating + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_fill_hi_n_narm)

m_growth <- glmer(VR ~ Growth_Habit + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_fill_hi_n_narm)

m_precip <- glmer(VR ~ Precip_mm + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_fill_hi_n_narm)

m_pdif <- glmer(VR ~ precip_dif + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_fill_hi_n_narm)

m_rating.n <- glmer(VR ~ rating.n + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_fill_hi_n_narm)

m_nativexgrowth <- glmer(VR ~ Native_Status*Growth_Habit + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_fill_hi_n_narm)

m_ratingxgrowth <- glmer(VR ~ Rating*Growth_Habit + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_fill_hi_n_narm)

m_nativexpop <- glmer(VR ~ Native_Status*Population + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_fill_hi_n_narm)

m_ratingxpop <- glmer(VR ~ Rating*Population + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_fill_hi_n_narm)

m_growthxpop <- glmer(VR ~ Growth_Habit*Population + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_fill_hi_n_narm)

m_nativexprecip <- glmer(VR ~ Native_Status*Precip_mm + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_fill_hi_n_narm)

m_ratingxprecip <- glmer(VR ~ Rating*Precip_mm + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_fill_hi_n_narm)

m_growthxprecip <- glmer(VR ~ Growth_Habit*Precip_mm + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_fill_hi_n_narm)

m_rating.nxpop <- glmer(VR ~ rating.n*Population + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_fill_hi_n_narm)

m_rating.nxgrowth <- glmer(VR ~ rating.n*Growth_Habit + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_fill_hi_n_narm)

m_rating.nxprecip <- glmer(VR ~ rating.n*Precip_mm + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_fill_hi_n_narm)


ICtab(m5
      ,m_native
      ,m_rating
      ,m_growth
      ,m_growthxpop
      ,m_growthxprecip
      ,m_nativexgrowth
      ,m_nativexpop
      ,m_nativexprecip
      ,m_pdif
      ,m_precip
      ,m_ratingxgrowth
      ,m_ratingxpop
      ,m_ratingxprecip
      ,m_rating.n
      ,m_rating.nxgrowth
      ,m_rating.nxpop
      ,m_rating.nxprecip)
lrtest(m_ratingxpop, m5)
Anova(m_ratingxpop)
summary(m_ratingxpop)
#mall

# Check for overdispersion
# deviance/residual df


### Come back to this

```

#### Model: Fl Mass

```{r}
str(repro_fill_hi_n_narm)

# Create ratio of fl to v
repro_fill_hi_n_narm$VR <- repro_fill_hi_n_narm$total_fl_mass_ln/repro_fill_hi_n_narm$Veg_Mass_ln

repro_fill_hi_n_narm <- repro_fill_hi_n_narm %>% 
  mutate(rating.n = (
    case_when(
      Rating == "Native" ~ 1
      , Rating == "Non-native" ~ 2
      , Rating == "Limited" ~ 3
      , Rating == "Moderate" ~ 4
      , Rating == "High" ~ 5
    )
  ))

m0 <- glm(total_fl_mass_ln ~ 1, family = gaussian, data = repro_fill_hi_n_narm)

m1 <- glmer(total_fl_mass_ln ~ 1 + (1|Scientific_Name), family = gaussian, data = repro_fill_hi_n_narm)

m2 <- glmer(total_fl_mass_ln ~ 1 + (1|Block/Shelter/Plot), family = gaussian, data = repro_fill_hi_n_narm)

m3 <- glmer(total_fl_mass_ln ~ 1 + (1|Block) + (1|Treatment), family = gaussian, data = repro_fill_hi_n_narm)

m4 <- glmer(total_fl_mass_ln ~ 1 + (1|Block/Shelter/Plot) + (1|Scientific_Name), family = gaussian, data = repro_fill_hi_n_narm)

m5 <- glmer(total_fl_mass_ln ~ 1 + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_fill_hi_n_narm)

m6 <- glmer(total_fl_mass_ln ~ 1 + (1|Block) + (1|Scientific_Name), family = gaussian, data = repro_fill_hi_n_narm)

ICtab(m0,m1,m2,m3,m4,m5,m6)

m5 <- glmer(total_fl_mass_ln ~ 1 + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_fill_hi_n_narm)

mV <- glmer(total_fl_mass_ln ~ Veg_Mass_ln + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_fill_hi_n_narm)

m_native <- glmer(total_fl_mass_ln ~ Native_Status*Veg_Mass_ln + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_fill_hi_n_narm)

m_rating <- glmer(total_fl_mass_ln ~ Rating*Veg_Mass_ln + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_fill_hi_n_narm)

m_growth <- glmer(total_fl_mass_ln ~ Growth_Habit*Veg_Mass_ln + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_fill_hi_n_narm)

m_precip <- glmer(total_fl_mass_ln ~ Precip_mm*Veg_Mass_ln + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_fill_hi_n_narm)

m_pdif <- glmer(total_fl_mass_ln ~ precip_dif*Veg_Mass_ln + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_fill_hi_n_narm)

m_rating.n <- glmer(total_fl_mass_ln ~ rating.n*Veg_Mass_ln + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_fill_hi_n_narm)

m_nativexgrowth <- glmer(total_fl_mass_ln ~ Native_Status*Growth_Habit*Veg_Mass_ln + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_fill_hi_n_narm)

m_ratingxgrowth <- glmer(total_fl_mass_ln ~ Rating*Growth_Habit*Veg_Mass_ln + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_fill_hi_n_narm)

m_nativexpop <- glmer(total_fl_mass_ln ~ Native_Status*Population*Veg_Mass_ln + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_fill_hi_n_narm)

m_ratingxpop <- glmer(total_fl_mass_ln ~ Rating*Population*Veg_Mass_ln + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_fill_hi_n_narm)

m_growthxpop <- glmer(total_fl_mass_ln ~ Growth_Habit*Population*Veg_Mass_ln + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_fill_hi_n_narm)

m_nativexprecip <- glmer(total_fl_mass_ln ~ Native_Status*Precip_mm*Veg_Mass_ln + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_fill_hi_n_narm)

m_ratingxprecip <- glmer(total_fl_mass_ln ~ Rating*Precip_mm*Veg_Mass_ln + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_fill_hi_n_narm)

m_growthxprecip <- glmer(total_fl_mass_ln ~ Growth_Habit*Precip_mm*Veg_Mass_ln + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_fill_hi_n_narm)

m_rating.nxpop <- glmer(total_fl_mass_ln ~ rating.n*Population*Veg_Mass_ln + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_fill_hi_n_narm)

m_rating.nxgrowth <- glmer(total_fl_mass_ln ~ rating.n*Growth_Habit*Veg_Mass_ln + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_fill_hi_n_narm)

m_rating.nxprecip <- glmer(total_fl_mass_ln ~ rating.n*Precip_mm*Veg_Mass_ln + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_fill_hi_n_narm)


ICtab(m5
      ,mV
      ,m_native
      ,m_rating
      ,m_growth
      ,m_growthxpop
      ,m_growthxprecip
      ,m_nativexgrowth
      ,m_nativexpop
      ,m_nativexprecip
      ,m_pdif
      ,m_precip
      ,m_ratingxgrowth
      ,m_ratingxpop
      ,m_ratingxprecip
      ,m_rating.n
      ,m_rating.nxgrowth
      ,m_rating.nxpop
      ,m_rating.nxprecip)
lrtest(m_growth, m5)
Anova(m_growth)
summary(m_growth)
#mall

# Check assumptions

```


I think it's best to keep it limited to growth habit and native status in terms of anova/a model. 

Then, for question three, limit it to species found at multiple locations. 

```{r}
# How to filter for species found in multiple populations

unique(repro_fill_hi_n_narm[which(repro_fill_hi_n_narm$Scientific_Name == "Avena barbata"),"Population"])
  
repro_fill_hi_n_narm %>% 
  group_by(Scientific_Name) %>% 
  count(Population)

repro_temp <- unique(repro_fill_hi_n_narm[,c("Scientific_Name","Population")])

repro_temp_2 <- repro_temp %>% 
  group_by(Scientific_Name) %>% 
  count() %>% 
  filter(n > 1)

mults <- repro_temp_2$Scientific_Name

repro_pop <- repro_fill_hi_n_narm %>% 
  filter(Scientific_Name %in% c(mults))

rm(
  repro_temp
  , repro_temp_2
  , mults
)
```

#### Bar: PopxSpecies

```{r}

# Graph, model, and analyze
anova(lm(total_fl_mass_ln ~ Veg_Mass_ln*Population*Scientific_Name, data = repro_pop))

mod <- lm(total_fl_mass_ln ~ Veg_Mass_ln*Population*Scientific_Name, 
          data = repro_pop)

slopes <- emtrends(mod, ~ Population*Scientific_Name, var = "Veg_Mass_ln")
slopes

slopes.df <- summary(slopes)

ggplot(slopes.df, aes(x = Scientific_Name, y = Veg_Mass_ln.trend,
                      fill = Population
                      )) + 
  geom_bar(position = position_dodge(), stat = "identity") +
  geom_hline(yintercept = 1, linetype = "dashed") +
  geom_errorbar(aes(ymin=Veg_Mass_ln.trend-SE, ymax=Veg_Mass_ln.trend+SE), width=0.3, colour='black', alpha=0.9, size=1.3, position = position_dodge(0.9)) +
  theme_classic() +
  theme(
    axis.text.x = element_text(face = "italic", angle = 45, vjust = 1, hjust = 1)) +
  scale_fill_manual(values = c("ANGELO" = "#440154FF", "MCL" = "#3B528BFF", "BORR" = "#21908CFF", "SEDG" = "#5DC863FF", "WWP" = "#FDE725FF")) +
  labs(x = "Species",
       y = "VR Slope",
       fill = "")

ggsave("slopes_popxspp.jpg")

# Add in aridity index
# Make Grass and Forb panel

```

#### Model: Pop

```{r}
str(repro_pop)

m0 <- glm(total_fl_mass_ln ~ 1, family = gaussian, data = repro_pop)

m1 <- glmer(total_fl_mass_ln ~ 1 + (1|Scientific_Name), family = gaussian, data = repro_pop)

m2 <- glmer(total_fl_mass_ln ~ 1 + (1|Block/Shelter/Plot), family = gaussian, data = repro_pop)

m3 <- glmer(total_fl_mass_ln ~ 1 + (1|Block) + (1|Treatment), family = gaussian, data = repro_pop)

m4 <- glmer(total_fl_mass_ln ~ 1 + (1|Block/Shelter/Plot) + (1|Scientific_Name), family = gaussian, data = repro_pop)

m5 <- glmer(total_fl_mass_ln ~ 1 + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_pop)

m6 <- glmer(total_fl_mass_ln ~ 1 + (1|Block) + (1|Scientific_Name), family = gaussian, data = repro_pop)

ICtab(m0,m1,m2,m3,m4,m5,m6)

m5 <- glmer(total_fl_mass_ln ~ 1 + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_pop)

mV <- glmer(total_fl_mass_ln ~ Veg_Mass_ln + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_pop)

m_native <- glmer(total_fl_mass_ln ~ Native_Status*Veg_Mass_ln + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_pop)

m_rating <- glmer(total_fl_mass_ln ~ Rating*Veg_Mass_ln + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_pop)

m_growth <- glmer(total_fl_mass_ln ~ Growth_Habit*Veg_Mass_ln + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_pop)

m_precip <- glmer(total_fl_mass_ln ~ Precip_mm*Veg_Mass_ln + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_pop)

m_pdif <- glmer(total_fl_mass_ln ~ precip_dif*Veg_Mass_ln + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_pop)

m_rating.n <- glmer(total_fl_mass_ln ~ rating.n*Veg_Mass_ln + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_pop)

m_nativexgrowth <- glmer(total_fl_mass_ln ~ Native_Status*Growth_Habit*Veg_Mass_ln + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_pop)

m_ratingxgrowth <- glmer(total_fl_mass_ln ~ Rating*Growth_Habit*Veg_Mass_ln + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_pop)

m_nativexpop <- glmer(total_fl_mass_ln ~ Native_Status*Population*Veg_Mass_ln + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_pop)

m_ratingxpop <- glmer(total_fl_mass_ln ~ Rating*Population*Veg_Mass_ln + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_pop)

m_growthxpop <- glmer(total_fl_mass_ln ~ Growth_Habit*Population*Veg_Mass_ln + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_pop)

m_nativexprecip <- glmer(total_fl_mass_ln ~ Native_Status*Precip_mm*Veg_Mass_ln + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_pop)

m_ratingxprecip <- glmer(total_fl_mass_ln ~ Rating*Precip_mm*Veg_Mass_ln + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_pop)

m_growthxprecip <- glmer(total_fl_mass_ln ~ Growth_Habit*Precip_mm*Veg_Mass_ln + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_pop)

m_rating.nxpop <- glmer(total_fl_mass_ln ~ rating.n*Population*Veg_Mass_ln + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_pop)

m_rating.nxgrowth <- glmer(total_fl_mass_ln ~ rating.n*Growth_Habit*Veg_Mass_ln + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_pop)

m_rating.nxprecip <- glmer(total_fl_mass_ln ~ rating.n*Precip_mm*Veg_Mass_ln + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_pop)

m_spei <- glmer(total_fl_mass_ln ~ spei_avg*Veg_Mass_ln + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_pop)

m_speixgrowth <- glmer(total_fl_mass_ln ~ spei_avg*Growth_Habit*Veg_Mass_ln + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_pop)

m_speixnative <- glmer(total_fl_mass_ln ~ spei_avg*Native_Status*Veg_Mass_ln + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_pop)

m_spei_p <- glmer(total_fl_mass_ln ~ spei_avg+Veg_Mass_ln + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_pop)

m_spei_p_xnative <- glmer(total_fl_mass_ln ~ spei_avg+Veg_Mass_ln*Native_Status + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_pop)

m_spei_p_xgrowth <- glmer(total_fl_mass_ln ~ spei_avg+Veg_Mass_ln*Growth_Habit + (1|Block) + (1|Treatment) + (1|Scientific_Name), family = gaussian, data = repro_pop)

ICtab(m5
      ,mV
      ,m_native
      ,m_rating
      ,m_growth
      ,m_growthxpop
      ,m_growthxprecip
      ,m_nativexgrowth
      ,m_nativexpop
      ,m_nativexprecip
      ,m_pdif
      ,m_precip
      ,m_ratingxgrowth
      ,m_ratingxpop
      ,m_ratingxprecip
      ,m_rating.n
      ,m_rating.nxgrowth
      ,m_rating.nxpop
      ,m_rating.nxprecip
      ,m_spei
      ,m_speixgrowth
      ,m_speixnative
      ,m_spei_p
      ,m_spei_p_xnative
      ,m_spei_p_xgrowth)

# m_spei_p_xnative, m_spei_p_xgrowth are the best. The growth/native term is effectively the same because all the grasses are non native and most of the forbs are native

lrtest(m_growth, m5)
Anova(m_speixnative)
summary(m_speixgrowth)
VarCorr(m_spei_p_xgrowth)


# Check assumptions

```
```{r}
# install.packages("ggeffects")
library(ggeffects)
library(ggplot2)

pred_int <- ggpredict(m_spei_p_xgrowth, terms = c("Veg_Mass_ln", "Growth_Habit"))

ggplot(pred_int, aes(x = x, y = predicted, color = group)) +
  geom_line(size = 1.2) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group),
              alpha = 0.2, color = NA) +
  theme_bw() +
  labs(x = "Vegetative Biomass (log)", 
       y = "Predicted Flower Mass (log)",
       color = "Growth Habit",
       fill = "Growth Habit")

pred_spei <- ggpredict(m_spei_p_xgrowth, terms = "spei_avg")

ggplot(pred_spei, aes(x, predicted)) +
  geom_line(size = 1.2) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = 0.2) +
  theme_bw() +
  labs(x = "SPEI (avg)", 
       y = "Predicted Flower Mass (log)")

# install.packages("sjPlot")
library(sjPlot)
plot_model(m_spei_p_xgrowth, type = "pred", terms = c("Veg_Mass_ln", "Growth_Habit"))


plot(m_spei_p_xgrowth)        # residual diagnostics
qqnorm(resid(m_spei_p_xgrowth))
qqline(resid(m_spei_p_xgrowth))

log(0.1)
```


### Analysis and Diving Deeper

- Look at Species from different populations
- Compare Native v non-native species
- Compare grasses and forbs
- Use model comparison to detect whether growth habit, native status, or perenniality are the best predictors of reproductive allometry

```{r}
level_order <- c('ANGELO', 'MCL', 'BORR','SEDG','WWP')

SiteColors <-
  setNames(c(viridis(5)), levels(c('ANGELO', 'MCL', 'BORR','SEDG','WWP')))

repro_AVEBAR <- repro_fill_hi_n_narm[which(repro_fill_hi_n_narm$Sp_Code == "AVEBAR"),]

repro_AVEBAR$Population <- factor(repro_AVEBAR$Population, levels = c("ANGELO", "MCL", "BORR","SEDG","WWP"))

ggplot(repro_AVEBAR, aes(x = Veg_Mass_ln, y = total_fl_mass_ln, color = Population)) +
  geom_abline(intercept = 0, slope = 1) +
  geom_point(aes(x = Veg_Mass_ln, y = total_fl_mass_ln, color = Population)) +
  geom_smooth(method = "lm", fill = NA) +
  scale_color_manual(values = c("ANGELO" = "#440154FF", "MCL" = "#3B528BFF", "BORR" = "#21908CFF", "SEDG" = "#5DC863FF", "WWP" = "#FDE725FF")) + 
  theme_bw() +
  labs(x = "ln(Vegetative Biomass (g))",
       y = "ln(Reproductive Biomass (g))",
       title = "Avena barbata") +
  theme(axis.text.x = element_text(size=9))

ggsave("Allom_log_plot_AVEBAR.jpg")

anova(lm(total_fl_mass_ln ~ Veg_Mass_ln*Population, data = repro_AVEBAR))
```

```{r}
repro_BRODIA <- repro_fill_hi_n_narm[which(repro_fill_hi_n_narm$Sp_Code == "BRODIA"),]

repro_BRODIA$Population <- factor(repro_BRODIA$Population, levels = c("ANGELO", "MCL", "BORR","SEDG","WWP"))

ggplot(repro_BRODIA, aes(x = Veg_Mass_ln, y = total_fl_mass_ln, color = Population)) +
  geom_abline(intercept = 0, slope = 1) +
  geom_point(aes(x = Veg_Mass_ln, y = total_fl_mass_ln, color = Population)) +
  geom_smooth(method = "lm", fill = NA) +
  scale_color_manual(values = c("ANGELO" = "#440154FF", "MCL" = "#3B528BFF", "BORR" = "#21908CFF", "SEDG" = "#5DC863FF", "WWP" = "#FDE725FF")) + 
  theme_bw() +
  labs(x = "ln(Vegetative Biomass (g))",
       y = "ln(Reproductive Biomass (g))",
       title = "Bromus diandrus") +
  theme(axis.text.x = element_text(size=9))

ggsave("Allom_log_plot_BRODIA.jpg")

anova(lm(total_fl_mass_ln ~ Veg_Mass_ln*Population, data = repro_BRODIA))
```
I wonder what would happen if we removed that rogue sample for SEDG

```{r}
repro_BROHOR <- repro_fill_hi_n_narm[which(repro_fill_hi_n_narm$Sp_Code == "BROHOR"),]

repro_BROHOR$Population <- factor(repro_BROHOR$Population, levels = c("ANGELO", "MCL", "BORR","SEDG","WWP"))

ggplot(repro_BROHOR, aes(x = Veg_Mass_ln, y = total_fl_mass_ln, color = Population)) +
  geom_abline(intercept = 0, slope = 1) +
  geom_point(aes(x = Veg_Mass_ln, y = total_fl_mass_ln, color = Population)) +
  geom_smooth(method = "lm", fill = NA) +
  scale_color_manual(values = c("ANGELO" = "#440154FF", "MCL" = "#3B528BFF", "BORR" = "#21908CFF", "SEDG" = "#5DC863FF", "WWP" = "#FDE725FF")) + 
  theme_bw() +
  labs(x = "ln(Vegetative Biomass (g))",
       y = "ln(Reproductive Biomass (g))",
       title = "Bromus hordeaceus") +
  theme(axis.text.x = element_text(size=9))

ggsave("Allom_log_plot_BROHOR.jpg")

anova(lm(total_fl_mass_ln ~ Veg_Mass_ln*Population, data = repro_BROHOR))
```

```{r}
repro_BROMAD <- repro_fill_hi_n_narm[which(repro_fill_hi_n_narm$Sp_Code == "BROMAD"),]

repro_BROMAD$Population <- factor(repro_BROMAD$Population, levels = c("ANGELO", "MCL", "BORR","SEDG","WWP"))

ggplot(repro_BROMAD, aes(x = Veg_Mass_ln, y = total_fl_mass_ln, color = Population)) +
  geom_abline(intercept = 0, slope = 1) +
  geom_point(aes(x = Veg_Mass_ln, y = total_fl_mass_ln, color = Population)) +
  geom_smooth(method = "lm", fill = NA) +
  scale_color_manual(values = c("ANGELO" = "#440154FF", "MCL" = "#3B528BFF", "BORR" = "#21908CFF", "SEDG" = "#5DC863FF", "WWP" = "#FDE725FF")) + 
  theme_bw() +
  labs(x = "ln(Vegetative Biomass (g))",
       y = "ln(Reproductive Biomass (g))",
       title = "Bromus madritensis") +
  theme(axis.text.x = element_text(size=9))

ggsave("Allom_log_plot_BROMAD.jpg")

anova(lm(total_fl_mass_ln ~ Veg_Mass_ln*Population, data = repro_BROMAD))
```

```{r}
repro_DAUPUS <- repro_fill_hi_n_narm[which(repro_fill_hi_n_narm$Sp_Code == "DAUPUS"),]

repro_DAUPUS$Population <- factor(repro_DAUPUS$Population, levels = c("ANGELO", "MCL", "BORR","SEDG","WWP"))

ggplot(repro_DAUPUS, aes(x = Veg_Mass_ln, y = total_fl_mass_ln, color = Population)) +
  geom_abline(intercept = 0, slope = 1) +
  geom_point(aes(x = Veg_Mass_ln, y = total_fl_mass_ln, color = Population)) +
  geom_smooth(method = "lm", fill = NA) +
  scale_color_manual(values = c("ANGELO" = "#440154FF", "MCL" = "#3B528BFF", "BORR" = "#21908CFF", "SEDG" = "#5DC863FF", "WWP" = "#FDE725FF")) + 
  theme_bw() +
  labs(x = "ln(Vegetative Biomass (g))",
       y = "ln(Reproductive Biomass (g))",
       title = "Daucus pusillus") +
  theme(axis.text.x = element_text(size=9))

ggsave("Allom_log_plot_DAUPUS.jpg")

anova(lm(total_fl_mass_ln ~ Veg_Mass_ln*Population, data = repro_DAUPUS))
```

```{r}
repro_LUPBIC <- repro_fill_hi_n_narm[which(repro_fill_hi_n_narm$Sp_Code == "LUPBIC"),]

repro_LUPBIC$Population <- factor(repro_LUPBIC$Population, levels = c("ANGELO", "MCL", "BORR","SEDG","WWP"))

ggplot(repro_LUPBIC, aes(x = Veg_Mass_ln, y = total_fl_mass_ln, color = Population)) +
  geom_abline(intercept = 0, slope = 1) +
  geom_point(aes(x = Veg_Mass_ln, y = total_fl_mass_ln, color = Population)) +
  geom_smooth(method = "lm", fill = NA) +
  scale_color_manual(values = c("ANGELO" = "#440154FF", "MCL" = "#3B528BFF", "BORR" = "#21908CFF", "SEDG" = "#5DC863FF", "WWP" = "#FDE725FF")) + 
  theme_bw() +
  labs(x = "ln(Vegetative Biomass (g))",
       y = "ln(Reproductive Biomass (g))",
       title = "Lupinus bicolor") +
  theme(axis.text.x = element_text(size=9))

ggsave("Allom_log_plot_LUPBIC.jpg")

anova(lm(total_fl_mass_ln ~ Veg_Mass_ln*Population, data = repro_LUPBIC))
```

```{r}
repro_MADGRA <- repro_fill_hi_n_narm[which(repro_fill_hi_n_narm$Sp_Code == "MADGRA"),]

repro_MADGRA$Population <- factor(repro_MADGRA$Population, levels = c("ANGELO", "MCL", "BORR","SEDG","WWP"))

ggplot(repro_MADGRA, aes(x = Veg_Mass_ln, y = total_fl_mass_ln, color = Population)) +
  geom_abline(intercept = 0, slope = 1) +
  geom_point(aes(x = Veg_Mass_ln, y = total_fl_mass_ln, color = Population)) +
  geom_smooth(method = "lm", fill = NA) +
  scale_color_manual(values = c("ANGELO" = "#440154FF", "MCL" = "#3B528BFF", "BORR" = "#21908CFF", "SEDG" = "#5DC863FF", "WWP" = "#FDE725FF")) + 
  theme_bw() +
  labs(x = "ln(Vegetative Biomass (g))",
       y = "ln(Reproductive Biomass (g))",
       title = "Madia gracilis") +
  theme(axis.text.x = element_text(size=9))

ggsave("Allom_log_plot_MADGRA.jpg")

anova(lm(total_fl_mass_ln ~ Veg_Mass_ln*Population, data = repro_MADGRA))
```

```{r}
repro_MICCAL <- repro_fill_hi_n_narm[which(repro_fill_hi_n_narm$Sp_Code == "MICCAL"),]

repro_MICCAL$Population <- factor(repro_MICCAL$Population, levels = c("ANGELO", "MCL", "BORR","SEDG","WWP"))

ggplot(repro_MICCAL, aes(x = Veg_Mass_ln, y = total_fl_mass_ln, color = Population)) +
  geom_abline(intercept = 0, slope = 1) +
  geom_point(aes(x = Veg_Mass_ln, y = total_fl_mass_ln, color = Population)) +
  geom_smooth(method = "lm", fill = NA) +
  scale_color_manual(values = c("ANGELO" = "#440154FF", "MCL" = "#3B528BFF", "BORR" = "#21908CFF", "SEDG" = "#5DC863FF", "WWP" = "#FDE725FF")) + 
  theme_bw() +
  labs(x = "ln(Vegetative Biomass (g))",
       y = "ln(Reproductive Biomass (g))",
       title = "Micropus californicus") +
  theme(axis.text.x = element_text(size=9))

ggsave("Allom_log_plot_MICCAL.jpg")

anova(lm(total_fl_mass_ln ~ Veg_Mass_ln*Population, data = repro_MADGRA))

# write_csv(repro_fill, "repro_growth_intern.csv")

```
It seems like for forbs they are conservative from southern populations and aggressive from northern and grasses (except BROMAD), they are aggressive from the south and conservative from the north? Forbs less often significant than grasses.


- Compare Native v non-native species
- Compare grasses and forbs
- Use model comparison to detect whether growth habit or native status are the best predictors of reproductive allometry

```{r}
ggplot(repro_fill_hi_n_narm, aes(x = Veg_Mass_ln, y = total_fl_mass_ln, color = Native_Status)) +
  #geom_abline(intercept = 0, slope = 1) +
  geom_point(aes(x = Veg_Mass_ln, y = total_fl_mass_ln, color = Native_Status, alpha = 0.5)) +
   guides(alpha = "none") +
  theme_bw() +
 geom_smooth(method = "lm", fill = NA) +
  theme(
    legend.text = element_text(size = 12.5),
    legend.title = element_text(size = 12.5),
    axis.text=element_text(size=8),
    axis.title=element_text(size=12.5),
    legend.position = "bottom"
  ) +
  scale_color_manual(values = c("Native" = "#440154FF", "Non-native" = "#5DC863FF")) +
  labs(x = "ln(Vegetative Biomass (g))",
       y = "ln(Reproductive Biomass (g))",
       color = "")

ggsave("Allom_log_plot_Native.jpg")

unique(repro_fill_hi_n_narm$total_fl_mass_ln)

anova(lm(total_fl_mass_ln ~ Veg_Mass_ln*Native_Status, data = repro_fill_hi_n_narm))

lmList(total_fl_mass_ln ~ Veg_Mass_ln | Native_Status, data = repro_fill_hi_n_narm)

```

```{r}
repro_fill_hi_n_narm$Population <- factor(repro_fill_hi_n_narm$Population, levels = c("ANGELO", "MCL", "BORR","SEDG","WWP"))

ggplot(repro_fill_hi_n_narm, aes(x = Veg_Mass_ln, y = total_fl_mass_ln, color = Population)) +
  geom_abline(intercept = 0, slope = 1) +
 # geom_point(aes(x = Veg_Mass_ln, y = total_fl_mass_ln, color = Population)) +
  geom_smooth(method = "lm", fill = NA) +
  scale_color_manual(values = c("ANGELO" = "#440154FF", "MCL" = "#3B528BFF", "BORR" = "#21908CFF", "SEDG" = "#5DC863FF", "WWP" = "#FDE725FF")) +
  theme_bw() +
  labs(x = "ln(Vegetative Biomass (g))",
       y = "ln(Reproductive Biomass (g))") +
  theme(axis.text.x = element_text(size=9))

ggsave("Allom_log_plot_Pop.jpg")

anova(lm(total_fl_mass_ln ~ Veg_Mass_ln*Population, data = repro_fill_hi_n_narm))

# Population is significant

lmList(total_fl_mass_ln ~ Veg_Mass_ln | Population, data = repro_fill_hi_n_narm)

```

Inspect functional type

```{r}
ggplot(repro_fill_hi_n_narm, aes(x = Veg_Mass_ln, y = total_fl_mass_ln, color = Native_Status)) +
  #geom_abline(intercept = 0, slope = 1) +
  geom_point(aes(x = Veg_Mass_ln, y = total_fl_mass_ln, color = Native_Status, alpha = 0.5)) +
   guides(alpha = "none") +
  theme_bw() +
 geom_smooth(method = "lm", fill = NA) +
  theme(
    legend.text = element_text(size = 12.5),
    legend.title = element_text(size = 12.5),
    axis.text=element_text(size=8),
    axis.title=element_text(size=12.5),
    legend.position = "bottom"
  ) +
  scale_color_manual(values = c("Native" = "#440154FF", "Non-native" = "#5DC863FF")) +
  labs(x = "ln(Vegetative Biomass (g))",
       y = "ln(Reproductive Biomass (g))",
       color = "")

ggsave("Allom_log_plot_Native.jpg")

ggplot(repro_fill_hi_n_narm, aes(x = Veg_Mass_ln, y = total_fl_mass_ln, color = Growth_Habit)) +
  # geom_abline(intercept = 0, slope = 1) +
  geom_point(aes(x = Veg_Mass_ln, y = total_fl_mass_ln, color = Growth_Habit, alpha = 0.5)) +
  guides(alpha = "none") +
  theme_bw() +
  geom_smooth(method = "lm", fill = NA) +
    theme(
    legend.position = "bottom"
  ) +
  scale_color_viridis(discrete=TRUE) +
  labs(x = "ln(Vegetative Biomass (g))",
       y = "ln(Reproductive Biomass (g))")


ggsave("Allom_log_plot_GrowthHab.jpg")

anova(lm(total_fl_mass_ln ~ Veg_Mass_ln*Growth_Habit, data = repro_fill_hi_n_narm))

lmList(total_fl_mass_ln ~ Veg_Mass_ln | Growth_Habit, data = repro_fill_hi_n_narm)

```

Looks awfully similar to native vs non-native plot. Need to parse out what's going on. 

I wonder if I looked at native vs non-native forbs only because all grasses featured are non-native. 

```{r}
repro_forb <- repro_fill_hi_n_narm %>% 
  filter(Growth_Habit == "Forb")

ggplot(repro_forb, aes(x = Veg_Mass_ln, y = total_fl_mass_ln, color = Native_Status)) +
  geom_abline(intercept = 0, slope = 1) +
  geom_point(aes(x = Veg_Mass_ln, y = total_fl_mass_ln, color = Native_Status, alpha = 0.5)) +
  geom_smooth(method = "lm", fill = NA) +
  theme_bw() +
  scale_color_viridis(discrete=TRUE) +
  labs(x = "ln(Vegetative Biomass (g))",
       y = "ln(Reproductive Biomass (g))") +
  theme(axis.text.x = element_text(size=9))

ggsave("Allom_log_plot_NativeForb.jpg")

anova(lm(total_fl_mass_ln ~ Veg_Mass_ln*Native_Status, data = repro_forb))

lmList(total_fl_mass_ln ~ Veg_Mass_ln | Native_Status, data = repro_forb)
```
They are the same.

And/or compared native v invasive v non-native.

```{r}
repro_fill_hi_n_narm$Rating<- factor(repro_fill_hi_n_narm$Rating, levels = c("Native", "Non-native","Limited","Moderate","High"))

ggplot(repro_fill_hi_n_narm, aes(x = Veg_Mass_ln, y = total_fl_mass_ln, color = Rating)) +
  geom_abline(intercept = 0, slope = 1) +
  geom_point(aes(x = Veg_Mass_ln, y = total_fl_mass_ln, color = Rating, alpha = 0.5)) +
  geom_smooth(method = "lm", fill = NA) +
  theme_bw() +
  scale_color_viridis(discrete=TRUE) +
  labs(x = "ln(Vegetative Biomass (g))",
       y = "ln(Reproductive Biomass (g))") +
  theme(axis.text.x = element_text(size=9))

ggsave("Allom_log_plot_NativeRating.jpg")

anova(lm(total_fl_mass_ln ~ Veg_Mass_ln*Rating, data = repro_fill_hi_n_narm))

lmList(total_fl_mass_ln ~ Veg_Mass_ln | Rating, data = repro_fill_hi_n_narm)


```

There's only two species with classification "High" so might not be a good metric. We could lump all the high and moderates together and limited and non-native together.

Then create a clustered bar graph where each cluster is a population and each bar is native, non-native, and invasive, and the bars indicate the RV slope.

Make a graph with Population on the x axis and slope of log(V) by log(R) on the y-axis. Each population has two bars one for average slope of native and one for average slope of non-native
```{r}
head(repro_fill_hi_n_narm)

anova(lm(total_fl_mass_ln ~ Veg_Mass_ln*Population*Native_Status, data = repro_fill_hi_n_narm))

mod <- lm(total_fl_mass_ln ~ Veg_Mass_ln:Population:Native_Status, data = repro_fill_hi_n_narm)
str(mod)

std_err <- summary(mod)$coefficients[, 2]
coefficients(mod)
cf <- coefficients(mod)
str(cf)
cf[1]
cf[2]

repro_summary <- repro_fill_hi_n_narm %>% 
  group_by(Population,Native_Status) %>% 
  summarise(slope = NA,
            std_err = NA)

## should also include std error

repro_summary[repro_summary$Population == 'ANGELO' & repro_summary$Native_Status == 'Native',3] <- cf["Veg_Mass_ln:PopulationANGELO:Native_StatusNative"]

repro_summary[repro_summary$Population == 'ANGELO' & repro_summary$Native_Status == 'Native',4] <- std_err["Veg_Mass_ln:PopulationANGELO:Native_StatusNative"]

repro_summary[repro_summary$Population == 'ANGELO' & repro_summary$Native_Status == 'Non-native',3] <- cf["Veg_Mass_ln:PopulationANGELO:Native_StatusNon-native"]

repro_summary[repro_summary$Population == 'ANGELO' & repro_summary$Native_Status == 'Non-native',4] <- std_err["Veg_Mass_ln:PopulationANGELO:Native_StatusNon-native"]

repro_summary[repro_summary$Population == 'MCL' & repro_summary$Native_Status == 'Native',3] <- cf["Veg_Mass_ln:PopulationMCL:Native_StatusNative"]

repro_summary[repro_summary$Population == 'MCL' & repro_summary$Native_Status == 'Native',4] <- std_err["Veg_Mass_ln:PopulationMCL:Native_StatusNative"]

repro_summary[repro_summary$Population == 'MCL' & repro_summary$Native_Status == 'Non-native',3] <- cf["Veg_Mass_ln:PopulationMCL:Native_StatusNon-native"]

repro_summary[repro_summary$Population == 'MCL' & repro_summary$Native_Status == 'Non-native',4] <- std_err["Veg_Mass_ln:PopulationMCL:Native_StatusNon-native"]

repro_summary[repro_summary$Population == 'BORR' & repro_summary$Native_Status == 'Native',3] <- cf["Veg_Mass_ln:PopulationBORR:Native_StatusNative"]

repro_summary[repro_summary$Population == 'BORR' & repro_summary$Native_Status == 'Native',4] <- std_err["Veg_Mass_ln:PopulationBORR:Native_StatusNative"]

repro_summary[repro_summary$Population == 'BORR' & repro_summary$Native_Status == 'Non-native',3] <- cf["Veg_Mass_ln:PopulationBORR:Native_StatusNon-native"]

repro_summary[repro_summary$Population == 'BORR' & repro_summary$Native_Status == 'Non-native',4] <- std_err["Veg_Mass_ln:PopulationBORR:Native_StatusNon-native"]

repro_summary[repro_summary$Population == 'SEDG' & repro_summary$Native_Status == 'Native',3] <- cf["Veg_Mass_ln:PopulationSEDG:Native_StatusNative"]

repro_summary[repro_summary$Population == 'SEDG' & repro_summary$Native_Status == 'Native',4] <- std_err["Veg_Mass_ln:PopulationSEDG:Native_StatusNative"]

repro_summary[repro_summary$Population == 'SEDG' & repro_summary$Native_Status == 'Non-native',3] <- cf["Veg_Mass_ln:PopulationSEDG:Native_StatusNon-native"]

repro_summary[repro_summary$Population == 'SEDG' & repro_summary$Native_Status == 'Non-native',4] <- std_err["Veg_Mass_ln:PopulationSEDG:Native_StatusNon-native"]

repro_summary[repro_summary$Population == 'WWP' & repro_summary$Native_Status == 'Native',3] <- cf["Veg_Mass_ln:PopulationWWP:Native_StatusNative"]

repro_summary[repro_summary$Population == 'WWP' & repro_summary$Native_Status == 'Native',4] <- std_err["Veg_Mass_ln:PopulationWWP:Native_StatusNative"]

repro_summary[repro_summary$Population == 'WWP' & repro_summary$Native_Status == 'Non-native',3] <- cf["Veg_Mass_ln:PopulationWWP:Native_StatusNon-native"]

repro_summary[repro_summary$Population == 'WWP' & repro_summary$Native_Status == 'Non-native',4] <- std_err["Veg_Mass_ln:PopulationWWP:Native_StatusNon-native"]

# add std error bars

precip <- read_csv("Site_Precip.csv")
precip$Precip_mm <- as.factor(precip$Precip_mm)
repro_summary_2 <- left_join(repro_summary,precip, by = join_by("Population"))

ggplot(repro_summary_2, aes(x = factor(Precip_mm, level=c('1780','757','603','380','320')), y = slope, fill = Native_Status)) + 
  geom_bar(position = position_dodge(), stat = "identity") +
  geom_errorbar(aes(ymin=slope-std_err, ymax=slope+std_err), width=0.3, colour="#FDE725FF", alpha=0.9, size=1.3, position = position_dodge(0.9)) +
  theme_bw() +
   theme(
    legend.text = element_text(size = 25),
    axis.text=element_text(size=16),
    axis.title=element_text(size=25),
    legend.position = "bottom"
  ) +
  scale_fill_manual(values = c("Native" = "#440154FF", "Non-native" = "#5DC863FF")) +
  labs(x = "Average Annual Precipitation (mm)",
       y = "Slope of log(V) and log(R)",
       fill = "")

ggsave("Slope_Pop_Native.jpg")

# It should align with this graph but it doesn't


ggplot(repro_fill_hi_n_narm, aes(x = Veg_Mass_ln, y = total_fl_mass_ln, color = Population, linetype = Native_Status)) +
  geom_abline(intercept = 0, slope = 1) +
 # geom_point(aes(x = Veg_Mass_ln, y = total_fl_mass_ln, color = Population)) +
  geom_smooth(method = "lm", fill = NA) +
  scale_color_manual(values = c("ANGELO" = "#440154FF", "MCL" = "#3B528BFF", "BORR" = "#21908CFF", "SEDG" = "#5DC863FF", "WWP" = "#FDE725FF")) +
  theme_bw() +
    scale_linetype_manual(values = c("Native" = "dashed", "Non-native" = "solid")) +
  labs(x = "ln(Vegetative Biomass (g))",
       y = "ln(Reproductive Biomass (g))") +
  theme(axis.text.x = element_text(size=9))

# These don't line up, doube check slope allocation, probs better to use emmeans

```

No clear pattern here. Look at tukey comparisons. Would need to see which species are driving these peaks and valleys.

Try it again with distance from common garden. Try grasses vs forbs for both x axis. Try native rating too. Also look at model fit for which factors are best predictors. Could also look at drought index of home sites versus davis

to-do list:
- Do anova looking at slope of native vs non native by precipitation
- Repeat bar graph and anova with grasses v forbs
- Repeat bar graph and anova using native, non-native, and invasive
- Do model comparison using population, precipitation, precip dif, Native status, Rating, growth habit, North-South

```{r}
head(repro_fill_hi_n_narm)

anova(lm(total_fl_mass_ln ~ Veg_Mass_ln*Population*Growth_Habit, data = repro_fill_hi_n_narm))

mod <- lm(total_fl_mass_ln ~ Veg_Mass_ln:Population:Growth_Habit, data = repro_fill_hi_n_narm)
str(mod)

std_err <- summary(mod)$coefficients[, 2]
coefficients(mod)
cf <- coefficients(mod)
str(cf)
cf[1]
cf[2]

repro_summary <- repro_fill_hi_n_narm %>% 
  group_by(Population,Growth_Habit) %>% 
  summarise(slope = NA,
            std_err = NA)

## should also include std error

repro_summary[repro_summary$Population == 'ANGELO' & repro_summary$Growth_Habit == 'Forb',3] <- cf["Veg_Mass_ln:PopulationANGELO:Growth_HabitForb"]

repro_summary[repro_summary$Population == 'ANGELO' & repro_summary$Growth_Habit == 'Forb',4] <- std_err["Veg_Mass_ln:PopulationANGELO:Growth_HabitForb"]

repro_summary[repro_summary$Population == 'ANGELO' & repro_summary$Growth_Habit == 'Grass',3] <- cf["Veg_Mass_ln:PopulationANGELO:Growth_HabitGrass"]

repro_summary[repro_summary$Population == 'ANGELO' & repro_summary$Growth_Habit == 'Grass',4] <- std_err["Veg_Mass_ln:PopulationANGELO:Growth_HabitGrass"]

repro_summary[repro_summary$Population == 'MCL' & repro_summary$Growth_Habit == 'Forb',3] <- cf["Veg_Mass_ln:PopulationMCL:Growth_HabitForb"]

repro_summary[repro_summary$Population == 'MCL' & repro_summary$Growth_Habit == 'Forb',4] <- std_err["Veg_Mass_ln:PopulationMCL:Growth_HabitForb"]

repro_summary[repro_summary$Population == 'MCL' & repro_summary$Growth_Habit == 'Grass',3] <- cf["Veg_Mass_ln:PopulationMCL:Growth_HabitGrass"]

repro_summary[repro_summary$Population == 'MCL' & repro_summary$Growth_Habit == 'Grass',4] <- std_err["Veg_Mass_ln:PopulationMCL:Growth_HabitGrass"]

repro_summary[repro_summary$Population == 'BORR' & repro_summary$Growth_Habit == 'Forb',3] <- cf["Veg_Mass_ln:PopulationBORR:Growth_HabitForb"]

repro_summary[repro_summary$Population == 'BORR' & repro_summary$Growth_Habit == 'Forb',4] <- std_err["Veg_Mass_ln:PopulationBORR:Growth_HabitForb"]

repro_summary[repro_summary$Population == 'BORR' & repro_summary$Growth_Habit == 'Grass',3] <- cf["Veg_Mass_ln:PopulationBORR:Growth_HabitGrass"]

repro_summary[repro_summary$Population == 'BORR' & repro_summary$Growth_Habit == 'Grass',4] <- std_err["Veg_Mass_ln:PopulationBORR:Growth_HabitGrass"]

repro_summary[repro_summary$Population == 'SEDG' & repro_summary$Growth_Habit == 'Forb',3] <- cf["Veg_Mass_ln:PopulationSEDG:Growth_HabitForb"]

repro_summary[repro_summary$Population == 'SEDG' & repro_summary$Growth_Habit == 'Forb',4] <- std_err["Veg_Mass_ln:PopulationSEDG:Growth_HabitForb"]

repro_summary[repro_summary$Population == 'SEDG' & repro_summary$Growth_Habit == 'Grass',3] <- cf["Veg_Mass_ln:PopulationSEDG:Growth_HabitGrass"]

repro_summary[repro_summary$Population == 'SEDG' & repro_summary$Growth_Habit == 'Grass',4] <- std_err["Veg_Mass_ln:PopulationSEDG:Growth_HabitGrass"]

repro_summary[repro_summary$Population == 'WWP' & repro_summary$Growth_Habit == 'Forb',3] <- cf["Veg_Mass_ln:PopulationWWP:Growth_HabitForb"]

repro_summary[repro_summary$Population == 'WWP' & repro_summary$Growth_Habit == 'Forb',4] <- std_err["Veg_Mass_ln:PopulationWWP:Growth_HabitForb"]

repro_summary[repro_summary$Population == 'WWP' & repro_summary$Growth_Habit == 'Grass',3] <- cf["Veg_Mass_ln:PopulationWWP:Growth_HabitGrass"]

repro_summary[repro_summary$Population == 'WWP' & repro_summary$Growth_Habit == 'Grass',4] <- std_err["Veg_Mass_ln:PopulationWWP:Growth_HabitGrass"]

# add std error bars

precip <- read_csv("Site_Precip.csv")
precip$Precip_mm <- as.factor(precip$Precip_mm)
repro_summary_2 <- left_join(repro_summary,precip, by = join_by("Population"))

ggplot(repro_summary_2, aes(x = factor(Precip_mm, level=c('1780','757','603','380','320')), y = slope, fill = Growth_Habit)) + 
  geom_bar(position = position_dodge(), stat = "identity") +
  geom_errorbar(aes(ymin=slope-std_err, ymax=slope+std_err), width=0.3, colour="#FDE725FF", alpha=0.9, size=1.3, position = position_dodge(0.9)) +
  theme_bw() +
   theme(
    legend.text = element_text(size = 25),
    axis.text=element_text(size=16),
    axis.title=element_text(size=25),
    legend.position = "bottom"
  ) +
  scale_fill_manual(values = c("Forb" = "#440154FF", "Grass" = "#5DC863FF")) +
  labs(x = "Average Annual Precipitation (mm)",
       y = "Slope of log(V) and log(R)",
       fill = "")

ggsave("Slope_Pop_Growth.jpg")

ggplot(repro_fill_hi_n_narm, aes(x = Veg_Mass_ln, y = total_fl_mass_ln, color = Population, linetype = Growth_Habit)) +
  geom_abline(intercept = 0, slope = 1) +
 # geom_point(aes(x = Veg_Mass_ln, y = total_fl_mass_ln, color = Population)) +
  geom_smooth(method = "lm", fill = NA) +
  scale_color_manual(values = c("ANGELO" = "#440154FF", "MCL" = "#3B528BFF", "BORR" = "#21908CFF", "SEDG" = "#5DC863FF", "WWP" = "#FDE725FF")) +
  theme_bw() +
    scale_linetype_manual(values = c("Forb" = "dashed", "Grass" = "solid")) +
  labs(x = "ln(Vegetative Biomass (g))",
       y = "ln(Reproductive Biomass (g))") +
  theme(axis.text.x = element_text(size=9))

# These don't line up, double check slope allocation, probs better to use emmeans

```
Also no clear pattern. "It seems like for forbs they are conservative from southern populations and aggressive from northern and grasses (except BROMAD), they are aggressive from the south and conservative from the north?" -- this pattern only play out among species in multiple populations, and it's relative to where they are. How might I capture that?

Now look at model comparison using population, precipitation, precip dif, Native status, Rating, growth habit, North-South.
 I wonder if the y variable can be the ratio between log?V and log?R, like where the point falls.
 
 
Question: How do you examine degree of influence of different species or populations?

```{r}
precip$Precip_mm <- as.numeric(precip$Precip_mm)
repro_fill_hi_n_narm <- left_join(repro_fill_hi_n_narm,precip, by = join_by("Population"))


m0 <- glm(total_fl_mass_ln ~ 1, family = gaussian, data = repro_fill_hi_n_narm)
m1 <- glm(total_fl_mass_ln ~ Veg_Mass_ln, family = gaussian, data = repro_fill_hi_n_narm)
m2 <- glmer(total_fl_mass_ln ~ Veg_Mass_ln + (1|Block), family = gaussian, data = repro_fill_hi_n_narm)

ICtab(m0,m1,m2)

m_v_p <- glm(total_fl_mass_ln ~ Veg_Mass_ln + Population, family = gaussian, data = repro_fill_hi_n_narm)

m_vxp <- glm(total_fl_mass_ln ~ Veg_Mass_ln*Population, family = gaussian, data = repro_fill_hi_n_narm)

m_v_pr <- glm(total_fl_mass_ln ~ Veg_Mass_ln + Precip_mm, family = gaussian, data = repro_fill_hi_n_narm)

m_vxpr <- glm(total_fl_mass_ln ~ Veg_Mass_ln*Precip_mm, family = gaussian, data = repro_fill_hi_n_narm)

m_v_pd <- glm(total_fl_mass_ln ~ Veg_Mass_ln + precip_dif, family = gaussian, data = repro_fill_hi_n_narm)

m_vxpd <- glm(total_fl_mass_ln ~ Veg_Mass_ln*precip_dif, family = gaussian, data = repro_fill_hi_n_narm)

m_v_n <- glm(total_fl_mass_ln ~ Veg_Mass_ln + Native_Status, family = gaussian, data = repro_fill_hi_n_narm)

m_vxn <- glm(total_fl_mass_ln ~ Veg_Mass_ln*Native_Status, family = gaussian, data = repro_fill_hi_n_narm)

m_v_r <- glm(total_fl_mass_ln ~ Veg_Mass_ln + Rating, family = gaussian, data = repro_fill_hi_n_narm)

m_vxr <- glm(total_fl_mass_ln ~ Veg_Mass_ln*Rating, family = gaussian, data = repro_fill_hi_n_narm)

m_v_g <- glm(total_fl_mass_ln ~ Veg_Mass_ln + Growth_Habit, family = gaussian, data = repro_fill_hi_n_narm)

m_vxg <- glm(total_fl_mass_ln ~ Veg_Mass_ln*Growth_Habit, family = gaussian, data = repro_fill_hi_n_narm)

m_v_s <- glm(total_fl_mass_ln ~ Veg_Mass_ln + Scientific_Name, family = gaussian, data = repro_fill_hi_n_narm)

m_vxs <- glm(total_fl_mass_ln ~ Veg_Mass_ln*Scientific_Name, family = gaussian, data = repro_fill_hi_n_narm)

ICtab(m0,
      m1,
      m2,
      m_v_p,
      m_vxp,
      m_v_pr,
      m_vxpr,
      m_v_pd,
      m_vxpd,
      m_v_n,
      m_vxn,
      m_v_r,
      m_vxr,
      m_v_g,
      m_vxg,
      m_v_s,
      m_vxs)
#lrtest(m_mons_max, m3)
#Anova(m_mons_max)
#summary(m_mons_max)
#mall

# Check for overdispersion
# deviance/residual df
#10314.2/27751 
```
Overwhelmingly the model that uses species as an explanatory variable is best. The invasive native question would be better investigated with traits. 

## Relative Growth Rate

### Clean up dataset

```{r}
rgr <- read_csv("Relative Growth Rate 2023 copy.csv")
plots <- read_csv("Plot_info copy.csv")
str(rgr)
summary(rgr)
head(rgr)
unique(rgr$Month)

# All IDs from May and June are missing ".1" at the end
# Extract species code from ID
# Extract plot, shelter letter from ID, add in block and population
rgr2 <- rgr %>% 
  mutate(Plant_ID = if_else(Month == "May" | Month == "June", true = paste0(Plant_ID, ".1"), false = Plant_ID),
         Sp_Code = substring(Plant_ID, 4,9),
         Plot = substring(Plant_ID, 1,2),) %>% 
  left_join(plots,by = join_by(Plot))
str(rgr2)  

unique(rgr2$Sp_Code)
unique(rgr2$Shelter)
unique(rgr2$Plot)

# Find gaps, investigate
# Fixed, entering errors besides A1.ACMPAR in May which is missing leaf count

incomplete_rows <- rgr2[,c("Plant_ID","Month","Height_cm","Leaf_number","canopy_x","canopy_y")]
incomplete_rows_2 <- incomplete_rows[!complete.cases(incomplete_rows),]
incomplete_rows_2 <- incomplete_rows_2[rowSums(is.na(incomplete_rows_2)) < 4,] 

# Find and investigate outliers
# Good job for interns
# Find average and standard deviation for each species, each growth variable (make area first), per population per month
str(rgr2)
rgr2$area <- as.numeric(rgr2$canopy_x)*as.numeric(rgr2$canopy_y)

rgr_avgs <- rgr2 %>% 
  group_by(Sp_Code,
           Month,
           Population) %>% 
  mutate(ht_avg = mean(Height_cm, na.rm = TRUE),
            ht_sd = sd(Height_cm, na.rm = TRUE),
            lf_avg = mean(Leaf_number, na.rm = TRUE),
            lf_sd = sd(Leaf_number, na.rm = TRUE),
            area_avg = mean(area, na.rm = TRUE),
            area_sd = sd(area, na.rm = TRUE),
            x_avg = mean(canopy_x, na.rm = TRUE),
            x_sd = sd(canopy_x, na.rm = TRUE),
            y_avg = mean(canopy_y, na.rm = TRUE),
            y_sd = sd(canopy_y, na.rm = TRUE)) %>% 
  select(Plant_ID,
         Sp_Code,
         Month,
         Population,
         Height_cm,
         ht_avg,
         ht_sd,
         Leaf_number,
         lf_avg,
         lf_sd,
         area,
         area_avg,
         area_sd,
         canopy_x,
         canopy_y,
         x_avg,
         x_sd,
         y_avg,
         y_sd)

rgr_avgs <- rgr_avgs[complete.cases(rgr_avgs),]

rgr_avgs <- rgr_avgs %>% 
  mutate(ht_max = ht_avg + 3*ht_sd,
         ht_min = ht_avg - 3*ht_sd,
         lf_max = lf_avg + 3*lf_sd,
         lf_min = lf_avg - 3*lf_sd,
         area_max = area_avg + 3*area_sd,
         area_min = area_avg - 3*area_sd,
         x_max = x_avg + 3*x_sd,
         x_min = x_avg - 3*x_sd,
         y_max = y_avg + 3*y_sd,
         y_min = y_avg - 3*y_sd)

ht_outliers <- rgr_avgs[which(rgr_avgs$Height_cm > rgr_avgs$ht_max | rgr_avgs$Height_cm < rgr_avgs$ht_min),c("Plant_ID","Sp_Code","Month","Population", "Height_cm","ht_avg","ht_sd","ht_min","ht_max")]

lf_outliers <- rgr_avgs[which(rgr_avgs$Leaf_number > rgr_avgs$lf_max | rgr_avgs$Leaf_number < rgr_avgs$lf_min),c("Plant_ID","Sp_Code","Month","Population", "Leaf_number","lf_avg","lf_sd","lf_min","lf_max")]

area_outliers <- rgr_avgs[which(rgr_avgs$area > rgr_avgs$area_max | rgr_avgs$area < rgr_avgs$area_min),c("Plant_ID","Sp_Code","Month","Population", "area","area_avg","area_sd","area_min","area_max")]

x_outliers <- rgr_avgs[which(rgr_avgs$canopy_x > rgr_avgs$x_max | rgr_avgs$canopy_x < rgr_avgs$x_min),c("Plant_ID","Sp_Code","Month","Population", "canopy_x","x_avg","x_sd","x_min","x_max")]

y_outliers <- rgr_avgs[which(rgr_avgs$canopy_y > rgr_avgs$y_max | rgr_avgs$canopy_y < rgr_avgs$y_min),c("Plant_ID","Sp_Code","Month","Population", "canopy_y","y_avg","y_sd","y_min","y_max")]

## Now go and investigate outliers using original data
```

### Create variables

```{r}
# Calculate canopy volume (height x canopy area)
head(rgr2)
rgr2$volume <- rgr2$Height_cm*rgr2$canopy_x*rgr2$canopy_y
rgr2$Date <- as.Date(rgr2$Date, tryFormats = "%m/%d/%y")
str(rgr2)

# Separate by metric

rgr_h_wide <- rgr2 %>% 
  select(Plant_ID,
         Date,
         Month,
         Height_cm) %>% 
  filter(!is.na(Height_cm)) %>%
  pivot_wider(id_cols = Plant_ID,
              names_from = Month,
              values_from = c(Date, Height_cm)) %>% 
  mutate(rgr_h_FM = (log(Height_cm_March)-log(Height_cm_February))/as.numeric((Date_March-Date_February)),
         rgr_h_MA = (log(Height_cm_April)-log(Height_cm_March))/as.numeric((Date_April-Date_March)),
         rgr_h_AM = (log(Height_cm_May)-log(Height_cm_April))/as.numeric((Date_May-Date_April)),
         rgr_h_MJ = (log(Height_cm_June)-log(Height_cm_May))/as.numeric((Date_June-Date_May)))

rgr_l_wide <- rgr2 %>% 
  select(Plant_ID,
         Date,
         Month,
         Leaf_number) %>% 
  filter(!is.na(Leaf_number)) %>%
  pivot_wider(id_cols = Plant_ID,
              names_from = Month,
              values_from = c(Date, Leaf_number)) %>% 
  mutate(rgr_l_FM = (log(Leaf_number_March)-log(Leaf_number_February))/as.numeric((Date_March-Date_February)),
         rgr_l_MA = (log(Leaf_number_April)-log(Leaf_number_March))/as.numeric((Date_April-Date_March)),
         rgr_l_AM = (log(Leaf_number_May)-log(Leaf_number_April))/as.numeric((Date_May-Date_April)),
         rgr_l_MJ = (log(Leaf_number_June)-log(Leaf_number_May))/as.numeric((Date_June-Date_May)))

rgr_v_wide <- rgr2 %>% 
  select(Plant_ID,
         Date,
         Month,
         volume) %>% 
  filter(!is.na(volume)) %>%
  pivot_wider(id_cols = Plant_ID,
              names_from = Month,
              values_from = c(Date, volume)) %>% 
  mutate(rgr_v_FM = (log(volume_March)-log(volume_February))/as.numeric((Date_March-Date_February)),
         rgr_v_MA = (log(volume_April)-log(volume_March))/as.numeric((Date_April-Date_March)),
         rgr_v_AM = (log(volume_May)-log(volume_April))/as.numeric((Date_May-Date_April)),
         rgr_v_MJ = (log(volume_June)-log(volume_May))/as.numeric((Date_June-Date_May)))
  
# Join all three together but only keep rgrs, full join by Plant_ID

rgr_h_l <- full_join(rgr_h_wide,rgr_l_wide,by = join_by(Plant_ID))

rgr_hlv <- full_join(rgr_h_l,rgr_v_wide,by = join_by(Plant_ID))

rgr_hlv2 <- rgr_hlv %>% 
  select(
    Plant_ID,
    rgr_h_FM,
    rgr_h_MA,
    rgr_h_AM,
    rgr_h_MJ,
    rgr_l_FM,
    rgr_l_MA,
    rgr_l_AM,
    rgr_l_MJ,
    rgr_v_FM,
    rgr_v_MA,
    rgr_v_AM,
    rgr_v_MJ
  )

## Wooooo we did it!
## Some values have -Inf, investigate that at some point. For now you're done!
```

### Exploratory Graphs
We have height, leaf number, area, and volume

```{r}
rgr_hlv2_long <- rgr_hlv2 %>% 
  pivot_longer(cols = c("rgr_h_FM":"rgr_v_MJ"),
               names_to = "var_mo",
               values_to = "rate") %>%
  filter(!is.na(rate))

rgr_sum <- rgr_hlv2_long %>%
  filter(!rate %in% c("-Inf","NaN","Inf")) %>% 
  group_by(var_mo) %>% 
  summarise(avg = mean(rate),
            stdev = sd(rate)) %>% 
  arrange(desc(avg))
```

Highest growth rate for volume is Feb-Mar (0.0957), then Mar-Apr (0.0827). For height, highest growth rate is Mar-Apr (0.0405), then Feb-Mar (0.0367). For leaves, highest growth rate is 0.0291 in Feb-Mar, then May-Jun 0.0198 (seems wrong). 
Interested in graphs for sure and population differences for sure but I think keep moving.

### Select Reference times
One predictive variable of allometric slope might be relative growth rate timing and/or maximum relative growth rate. 

Highest growth rate for volume is Feb-Mar (0.0957), then Mar-Apr (0.0827). For height, highest growth rate is Mar-Apr (0.0405), then Feb-Mar (0.0367). For leaves, highest growth rate is 0.0291 in Feb-Mar, then May-Jun 0.0198 (seems wrong).

### Explore RGR

```{r}
rgr_hlv2

# parse out plant ID for species, plot, Population
plots <- read_csv("Plot_info copy.csv")
str(plots)
summary(plots)
head(plots)

spp <- read_csv("Species Codes copy.csv")
unique(spp$Sp_Code)
unique(repro$Species)

# need to pull out first two characters in string of plant ID to create a "plot" column

rgr_hlv <- rgr_hlv2 %>% 
  mutate(Plot = substr(Plant_ID, start = 1, stop = 2),
         Species = substr(Plant_ID, start = 4, stop = 9))
unique(rgr_hlv$Plot)
unique(rgr_hlv$Species)

rgr_hlv_full <- left_join(rgr_hlv,plots,by = join_by(Plot))

rgr_hlv_full$Sp_Code <- rgr_hlv$Species

rgr_hlv_full <- left_join(rgr_hlv_full,spp,by = join_by(Sp_Code))

rgr_h <- rgr_hlv_full %>% 
  select(
    Plant_ID,
    Sp_Code,
    Scientific_Name,
    Native_Status,
    Growth_Habit,
    Rating,
    Source,
    Plot,
    Block,
    Shelter,
    Plot_number,
    Population,
    Treatment,
    rgr_h_FM,
    rgr_h_MA,
    rgr_h_AM,
    rgr_h_MJ
  ) %>% 
  pivot_longer(cols = c("rgr_h_FM":"rgr_h_MJ"),
               names_to = "var_mo",
               values_to = "rate")

rgr_l <- rgr_hlv_full %>% 
  select(
    Plant_ID,
    Sp_Code,
    Scientific_Name,
    Native_Status,
    Growth_Habit,
    Rating,
    Source,
    Plot,
    Block,
    Shelter,
    Plot_number,
    Population,
    Treatment,
    rgr_l_FM,
    rgr_l_MA,
    rgr_l_AM,
    rgr_l_MJ
  ) %>% 
  pivot_longer(cols = c("rgr_l_FM":"rgr_l_MJ"),
               names_to = "var_mo",
               values_to = "rate")

rgr_v <- rgr_hlv_full %>% 
  select(
    Plant_ID,
    Sp_Code,
    Scientific_Name,
    Native_Status,
    Growth_Habit,
    Rating,
    Source,
    Plot,
    Block,
    Shelter,
    Plot_number,
    Population,
    Treatment,
    rgr_v_FM,
    rgr_v_MA,
    rgr_v_AM,
    rgr_v_MJ
  ) %>% 
  pivot_longer(cols = c("rgr_v_FM":"rgr_v_MJ"),
               names_to = "var_mo",
               values_to = "rate")
```

Start graphing, what do I want to see? growth rate by rating or native status across months
```{r}
# Order Invasive rating: Native, Non-native, Limited, Moderate, High
# Order Month rates

rgr_h$Rating<- factor(rgr_h$Rating, levels = c("Native", "Non-native","Limited","Moderate","High"))
rgr_h$var_mo<- factor(rgr_h$var_mo, levels = c("rgr_h_FM", "rgr_h_MA","rgr_h_AM","rgr_h_MJ"))

# Change violin plot colors by groups
ggplot(rgr_h, aes(x=var_mo, y=rate, fill=Rating)) +
  geom_violin()
ggplot(rgr_h, aes(x=var_mo, y=rate, fill=Native_Status)) +
  geom_violin()


rgr_l$Rating<- factor(rgr_l$Rating, levels = c("Native", "Non-native","Limited","Moderate","High"))
rgr_l$var_mo<- factor(rgr_l$var_mo, levels = c("rgr_l_FM", "rgr_l_MA","rgr_l_AM","rgr_l_MJ"))

ggplot(rgr_l, aes(x=var_mo, y=rate, fill=Rating)) +
  geom_violin()
ggplot(rgr_l, aes(x=var_mo, y=rate, fill=Native_Status)) +
  geom_violin()

rgr_v$Rating<- factor(rgr_v$Rating, levels = c("Native", "Non-native","Limited","Moderate","High"))
rgr_v$var_mo<- factor(rgr_v$var_mo, levels = c("rgr_v_FM", "rgr_v_MA","rgr_v_AM","rgr_v_MJ"))

ggplot(rgr_v, aes(x=var_mo, y=rate, fill=Rating)) +
  geom_violin()
ggplot(rgr_v, aes(x=var_mo, y=rate, fill=Native_Status)) +
  geom_violin()


```
Should almost look at each of these graphs by population, so it's limited to community. It's possible an invasive from Angelo has the same growth rate as a native from santa barbara.

```{r}
rgr_h_ACR <- rgr_h %>% 
  filter(Population == "ANGELO")

rgr_h_MCL <- rgr_h %>% 
  filter(Population == "MCL")

rgr_h_BORR <- rgr_h %>% 
  filter(Population == "BORR")

rgr_h_SEDG <- rgr_h %>% 
  filter(Population == "SEDG")

# Change violin plot colors by groups
ggplot(rgr_h_ACR, aes(x=var_mo, y=rate, fill=Rating)) +
  geom_violin()
ggplot(rgr_h_ACR, aes(x=var_mo, y=rate, fill=Native_Status)) +
  geom_violin()

ggplot(rgr_h_MCL, aes(x=var_mo, y=rate, fill=Rating)) +
  geom_violin()
ggplot(rgr_h_MCL, aes(x=var_mo, y=rate, fill=Native_Status)) +
  geom_violin()

ggplot(rgr_h_BORR, aes(x=var_mo, y=rate, fill=Rating)) +
  geom_violin()
ggplot(rgr_h_BORR, aes(x=var_mo, y=rate, fill=Native_Status)) +
  geom_violin()

ggplot(rgr_h_SEDG, aes(x=var_mo, y=rate, fill=Rating)) +
  geom_violin()
ggplot(rgr_h_SEDG, aes(x=var_mo, y=rate, fill=Native_Status)) +
  geom_violin()

ggplot(rgr_l, aes(x=var_mo, y=rate, fill=Rating)) +
  geom_violin()
ggplot(rgr_l, aes(x=var_mo, y=rate, fill=Native_Status)) +
  geom_violin()



ggplot(rgr_v, aes(x=var_mo, y=rate, fill=Rating)) +
  geom_violin()
ggplot(rgr_v, aes(x=var_mo, y=rate, fill=Native_Status)) +
  geom_violin()
```
These graphs should give us clues about invasive coverage and niche dynamics and competition within each plot.

Now curious how these relate to reproductive allocation/scaling

Remember we didn't know who each grass was in February. So might need to throw those out OR separate by growth habit.

## Photosynthetic Rate

```{r}
#| warning: false
#| message: false
# how to tell it the header and which rows to skip
# how to read through the filenames in a certain folder and make a list and then read those in 1 by 1
getwd()
licor_files <- list.files("/Users/brookewainwright/Documents/GitHub_Projects/growth-reproduction/licor")
licor_files[4]

trial <- read_csv(licor_files[4], skip = 1, col_select = "obs":"gtc")

lic <- list() # creates a list
for (k in 1:length(licor_files)){
 lic[[k]] <- read_csv(licor_files[k], skip = 1, col_select = "obs":"gtc")
}

lic <- lapply(lic, function(tbl) {
  tbl$WUE <- as.numeric(tbl$WUE)
  return(tbl)
})

licor <- bind_rows(lic)
licor <- licor %>% 
  filter(!is.na(obs))

```

Now I need to bring in Licor leaf area csv and join. Also need to double check numbers for each species.

GALPAR, Holvir, miccal not working -- fixed, just needed to adjust minimum size.

```{r}
#| eval: false
amsmen = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/growth-reproduction/Licor Leaf Area copy/AMSMEN",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE)
amsmen<-amsmen$summary

avebar = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/growth-reproduction/Licor Leaf Area copy/AVEBAR",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE)
avebar<-avebar$summary

?run.ij

broare = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/growth-reproduction/Licor Leaf Area copy/BROARE",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE)
broare<-broare$summary

brodia = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/growth-reproduction/Licor Leaf Area copy/BRODIA",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE)
brodia<-brodia$summary

brohor = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/growth-reproduction/Licor Leaf Area copy/BROHOR",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE)
brohor<-brohor$summary

bromad = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/growth-reproduction/Licor Leaf Area copy/BROMAD",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE,
              low.size = 0.005)
bromad<-bromad$summary

calmen = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/growth-reproduction/Licor Leaf Area copy/CALMEN",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE,
              low.size = 0.005)
calmen<-calmen$summary

caucou = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/growth-reproduction/Licor Leaf Area copy/CAUCOU",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE)
caucou<-caucou$summary

cenmel = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/growth-reproduction/Licor Leaf Area copy/CENMEL",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE)
cenmel<-cenmel$summary

clapur = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/growth-reproduction/Licor Leaf Area copy/CLAPUR",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE,
              low.size = 0.005)
clapur<-clapur$summary

corfil = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/growth-reproduction/Licor Leaf Area copy/CORFIL",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE)
corfil<-corfil$summary

daupus = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/growth-reproduction/Licor Leaf Area copy/DAUPUS",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE)
daupus<-daupus$summary

elycap = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/growth-reproduction/Licor Leaf Area copy/ELYCAP",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE)
elycap<-elycap$summary

erobot = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/growth-reproduction/Licor Leaf Area copy/EROBOT",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE)
erobot<-erobot$summary

erocic = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/growth-reproduction/Licor Leaf Area copy/EROCIC",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE,
              low.size = 0.005)
erocic<-erocic$summary

esccal = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/growth-reproduction/Licor Leaf Area copy/ESCCAL",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE,
              low.size = 0.005)
esccal<-esccal$summary


galpar = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/growth-reproduction/Licor Leaf Area copy/GALPAR", 
                distance.pixel = 355, 
                known.distance = 3,
                low.size = 0.005,
                log = TRUE)
          #      save.image = TRUE)
galpar<-galpar$summary

gerdis = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/growth-reproduction/Licor Leaf Area copy/GERDIS",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE)
gerdis<-gerdis$summary

holvir = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/growth-reproduction/Licor Leaf Area copy/HOLVIR", 
                distance.pixel = 355, 
                known.distance = 3, 
                low.size = 0.005,
                log = TRUE)
                # save.image = TRUE)
holvir<-holvir$summary

hypgla = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/growth-reproduction/Licor Leaf Area copy/HYPGLA",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE)
hypgla<-hypgla$summary

lupbic = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/growth-reproduction/Licor Leaf Area copy/LUPBIC",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE,
              low.size = 0.005)
lupbic<-lupbic$summary

lupmic = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/growth-reproduction/Licor Leaf Area copy/LUPMIC",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE)
lupmic<-lupmic$summary

lupsuc = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/growth-reproduction/Licor Leaf Area copy/LUPSUC",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE)
lupsuc<-lupsuc$summary

madgra = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/growth-reproduction/Licor Leaf Area copy/MADGRA",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE)
madgra<-madgra$summary

miccal = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/growth-reproduction/Licor Leaf Area copy/MICCAL", 
                distance.pixel = 355, 
                known.distance = 3, 
                low.size = 0.005,
                log = TRUE)
             #   save.image = TRUE)
miccal<-miccal$summary

phatan = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/growth-reproduction/Licor Leaf Area copy/PHATAN",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE)
phatan<-phatan$summary

plaere = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/growth-reproduction/Licor Leaf Area copy/PLAERE",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE,
              low.size = 0.005)
plaere<-plaere$summary

stipul = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/growth-reproduction/Licor Leaf Area copy/STIPUL",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE,
              low.size = 0.005)
stipul<-stipul$summary

torarv = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/growth-reproduction/Licor Leaf Area copy/TORARV",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE)
torarv<-torarv$summary

trihir = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/growth-reproduction/Licor Leaf Area copy/TRIHIR",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE,
              low.size = 0.005)
trihir<-trihir$summary

vicsat = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/growth-reproduction/Licor Leaf Area copy/VICSAT",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE)
vicsat<-vicsat$summary

# missing galpar, miccal, holvir
leaf_licor_area <- rbind(amsmen,
                         avebar,
                         broare,
                         brodia,
                         brohor,
                         bromad,
                         calmen,
                         caucou,
                         cenmel,
                         clapur,
                         corfil,
                         daupus,
                         elycap,
                         erobot,
                         erocic,
                         esccal,
                         galpar,
                         gerdis,
                         holvir,
                         hypgla,
                         lupbic,
                         lupmic,
                         lupsuc,
                         madgra,
                         miccal,
                         phatan,
                         plaere,
                         stipul,
                         torarv,
                         trihir,
                         vicsat)

write_csv(leaf_licor_area, "leaf_licor_area.csv")
```

Double check that the numbers of values per species aligns with number of images per species folder. -- All good

Then merge with Licor dataset by plant ID.

```{r}
# Separate date from plant ID, make in date format
leaf_licor_area <- read_csv("leaf_licor_area.csv")
head(leaf_licor_area)
head(licor)

licor$Date <- as.Date(substr(licor$date, start=1, stop=10))
str(licor$Date)

leaf_licor_area$Date <- as.Date(substr(leaf_licor_area$sample, start=11, stop=18), "%Y%m%d")
str(licor$Date)

# separate plant ID from same and add periods to plant id
leaf_licor_area$Plant_ID <- substr(leaf_licor_area$sample, start=1,stop=9)
leaf_licor_area$Plant_ID <- paste0(
  substr(leaf_licor_area$Plant_ID, 1, 2),
  ".",
  substr(leaf_licor_area$Plant_ID, 3, nchar(leaf_licor_area$Plant_ID))
)
leaf_licor_area$Plant_ID

leaf_licor_area$Plant_ID <- paste0(
  substr(leaf_licor_area$Plant_ID, 1, 9),
  ".",
  substr(leaf_licor_area$Plant_ID, 10, nchar(leaf_licor_area$Plant_ID))
)
leaf_licor_area$Plant_ID

# capitalize Licor plant id
licor$Plant_ID <- toupper(licor$`plant id`)

# merge with licor leaf area
licor2 <- left_join(licor,leaf_licor_area,by=c("Plant_ID" = "Plant_ID"))

# Come back and investigate NAs for licor2 -- why are some leaf areas missing
licor.na <- licor2 %>% 
  filter(is.na(total.leaf.area))

unique(licor.na$Plant_ID)
licor2[which(licor2$Plant_ID == "E4.PHATAN.2-E2"),]
# AIRCAR, ACMPAR is not present
# For some reason the ones with dashes aren't lining up
# A4 BROHOR has no match but it shouldn't because there was no brohor in wwp -- should be a3
# E8 CENMEL doesn't have a match but it shouldnt because CENMEL should be in e5 or e6
# Such a mess, think about just taking off the number at the end
# Come back to this

# multiply focal data by leaf area fraction
licor2$leaf_ratio <- 6/licor2$total.leaf.area
licor2 <- licor2 %>% 
  filter(!is.na(total.leaf.area)) %>% # filter NAs for now
  mutate(WUE_adj = leaf_ratio*WUE,
         E_adj = leaf_ratio*as.numeric(E),
         A_adj = leaf_ratio*as.numeric(A),
         Ci_adj = leaf_ratio*as.numeric(Ci),
         gsw_adj = leaf_ratio*as.numeric(gsw))
str(licor2)

# remove licor data with gsw below threshold
licor2[which(licor2$gsw_adj < 0.03),]

# There are values from September 2020???? investigate
# Weirdly this file 2023-04-30-0922_BRODIA_39.csv has the date at Sep 2020, some glitch. will need to fix
# September 23, 2020

# test for licor outliers by species, population, and treatment



# average licor data by plant_id
licor3 <- licor2 %>% 
  group_by(Plant_ID) %>% 
  summarise(A_adj_av = mean(A_adj, na.rm=TRUE),
            WUE_adj_av= mean(WUE_adj, na.rm = TRUE),
            E_adj_av=mean(E_adj, na.rm = TRUE),
            Ci_adj_av = mean(Ci_adj, na.rm = TRUE),
            gsw_adj_av = mean(gsw_adj, na.rm = TRUE))

# extract species and plot from plant id
licor3$Sp_Code <- substr(licor3$Plant_ID,4,9)
licor3$Plot <- substr(licor3$Plant_ID,1,2)

# merge with plot and species info
licor4 <- left_join(licor3,plots, by = join_by(Plot))
licor5 <- left_join(licor4,spp, by = join_by(Sp_Code))
```

### Explore licor
```{r}
summary(licor5)
# okay some things are way off with WUE, and others -- will need to deal with outliers at some point

p <- ggplot(licor5, aes(x=Sp_Code, y=A_adj_av)) +
  geom_violin() + stat_summary(fun.data=mean_sdl, mult=1, 
                 geom="pointrange", color="red") + theme(axis.text.x = element_text(angle=90,hjust = 1, size=14, color="black") )
p

p <- ggplot(licor5, aes(x=Rating, y=A_adj_av)) +
  geom_violin() + stat_summary(fun.data=mean_sdl, mult=1, 
                 geom="pointrange", color="red") + theme(axis.text.x = element_text(angle=90,hjust = 1, size=14, color="black") )
p

```


## Leaf Mass Area
```{r}
lf_area <- read_csv("LMA_lfarea_all.csv")

## Extract plant id, species, plot
lf_area$Date <- as.Date(substr(lf_area$sample, start=11, stop=18), "%Y%m%d")

# separate plant ID from same and add periods to plant id
lf_area$Plant_ID <- substr(lf_area$sample, start=1,stop=9)
lf_area$Plant_ID <- paste0(
  substr(lf_area$Plant_ID, 1, 2),
  ".",
  substr(lf_area$Plant_ID, 3, nchar(lf_area$Plant_ID))
)
lf_area$Plant_ID

lf_area$Plant_ID <- paste0(
  substr(lf_area$Plant_ID, 1, 9),
  ".",
  substr(lf_area$Plant_ID, 10, nchar(lf_area$Plant_ID))
)
lf_area$Plant_ID

lf_area$Sp_Code <- substr(lf_area$Plant_ID,4,9)
lf_area$Plot <- substr(lf_area$Plant_ID,1,2)

# merge with plot and species info
lf_area2 <- left_join(lf_area,plots, by = join_by(Plot))
lf_area3 <- left_join(lf_area2,spp, by = join_by(Sp_Code))

# Now merge with leaf mass and calculate LMA
mass <- read_csv("Leaf Mass_2023_20231009.csv")
head(mass)

LMA <- left_join(lf_area3,mass, by = join_by(Plant_ID))
# LMA is measured in g/m^2

LMA$area_m2 <- LMA$total.leaf.area/10000
LMA$lma_g_m2 <- LMA$area_m2/LMA$Dry_leaf_mass_g

```

### Explore LMA
```{r}
summary(LMA)
# okay some things are way off with WUE, and others -- will need to deal with outliers at some point

ggplot(LMA, aes(x=Sp_Code, y=lma_g_m2)) +
  geom_violin() + stat_summary(fun.data=mean_sdl, mult=1, 
                 geom="pointrange", color="red") + theme(axis.text.x = element_text(angle=90,hjust = 1, size=14, color="black") )


ggplot(LMA, aes(x=Rating, y=lma_g_m2)) +
  geom_violin() + stat_summary(fun.data=mean_sdl, mult=1, 
                 geom="pointrange", color="red") + theme(axis.text.x = element_text(angle=90,hjust = 1, size=14, color="black") )

```

## Leaf Area
```{r}
lf_area3

summary(lf_area3)

ggplot(lf_area3, aes(x=Sp_Code, y=total.leaf.area)) +
  geom_violin() + stat_summary(fun.data=mean_sdl, mult=1, 
                 geom="pointrange", color="red") + theme(axis.text.x = element_text(angle=90,hjust = 1, size=14, color="black") )

ggplot(lf_area3, aes(x=Rating, y=total.leaf.area)) +
  geom_violin() + stat_summary(fun.data=mean_sdl, mult=1, 
                 geom="pointrange", color="red") + theme(axis.text.x = element_text(angle=90,hjust = 1, size=14, color="black") )

```


## WUE

```{r}
summary(licor5)

licor_sanSTIPULELYCAP <- licor5 %>% 
  filter(!Sp_Code %in% c("STIPUL","ELYCAP"))
ggplot(licor_sanSTIPULELYCAP, aes(x=Sp_Code, y=WUE_adj_av)) +
  geom_violin() + stat_summary(fun.data=mean_sdl, mult=1, 
                 geom="pointrange", color="red") + theme(axis.text.x = element_text(angle=90,hjust = 1, size=14, color="black") )

ggplot(licor_sanSTIPULELYCAP, aes(x=Rating, y=WUE_adj_av)) +
  geom_violin() + stat_summary(fun.data=mean_sdl, mult=1, 
                 geom="pointrange", color="red") + theme(axis.text.x = element_text(angle=90,hjust = 1, size=14, color="black") )

# What are normal ranges for WUE?

```

## Height
```{r}
head(rgr2)
rgr_h <- rgr2 %>% 
  select(
    Plant_ID,
    Month,
    Height_cm,
    Sp_Code,
    Plot,
    Block,
    Shelter,
    Plot_number,
    Population,
    Treatment
  )

rgr_max_h <- rgr_h %>% 
  group_by(Plant_ID) %>% 
  summarise(h_max = max(Height_cm, na.rm = TRUE),
            Sp_Code = Sp_Code,
            Plot = Plot,
            Population = Population,
            Treatment = Treatment
            ) 
rgr_max_h <- rgr_max_h[-which(duplicated(rgr_max_h)),]


rgr_max_h2 <- left_join(rgr_max_h,plots, by = join_by(Plot))
rgr_max_h3 <- left_join(rgr_max_h2,spp, by = join_by(Sp_Code))

ggplot(rgr_max_h3, aes(x=Sp_Code, y=h_max)) +
  geom_violin() + stat_summary(fun.data=mean_sdl, mult=1, 
                 geom="pointrange", color="red") + theme(axis.text.x = element_text(angle=90,hjust = 1, size=14, color="black") )

ggplot(rgr_max_h3, aes(x=Rating, y=h_max)) +
  geom_violin() + stat_summary(fun.data=mean_sdl, mult=1, 
                 geom="pointrange", color="red") + theme(axis.text.x = element_text(angle=90,hjust = 1, size=14, color="black") )



```

## Leaf Nitrogen

```{r}
cn <- read_csv("CN_2023.csv")
str(cn)

# break out species from sample ID
cn$Sp_Code <- substr(cn$Sample_ID,4,9)

sp_n <- count(cn, "Sp_Code")
sp_n[which(sp_n$freq < 4),1]
sp_rm <- sp_n[which(sp_n$freq < 4),1] 

cn <- cn %>% 
  filter(!Sp_Code %in% sp_rm)

str(cn)

cn_sum <- cn %>% 
  group_by(Sp_Code) %>%
  dplyr::summarise(mean_c13 = mean(13CVPDB_permil),
                   std_c13 = sd(13CVPDB_permil),
                   mean_n = mean(Total_N_g),
                   std_n = sd(Total_N_g),
                   mean_n15 = mean(15NAir_permil),
                   std_n15 = sd(15NAir_permil))

cn_sum <- cn_sum %>% 
  mutate(c13_max = mean_c13 + 3*std_c13,
         c13_min = mean_c13 - 3*std_c13,
         n_max = mean_n + 3*std_n,
         n_min = mean_n - 3*std_n,
         n15_max = mean_n15 + 3*std_n15,
         n15_min = mean_n15 - 3*std_n15)

cn_avgs <- left_join(cn, cn_sum, by=join_by("Sp_Code"))

c13_outliers <- cn_avgs[which(cn_avgs$13CVPDB_permil > cn_avgs$c13_max | cn_avgs$13CVPDB_permil < cn_avgs$c13_min),c("Sample_ID","Sp_Code", "13CVPDB_permil","mean_c13","std_c13","c13_max","c13_min")]

n_outliers <- cn_avgs[which(cn_avgs$Total_N_g > cn_avgs$n_max | cn_avgs$Total_N_g < cn_avgs$n_min),c("Sample_ID","Sp_Code", "Total_N_g","mean_n","std_n","n_max","n_min")]

n15_outliers <- cn_avgs[which(cn_avgs$15NAir_permil > cn_avgs$n15_max | cn_avgs$15NAir_permil < cn_avgs$n15_min),c("Sample_ID","Sp_Code", "15NAir_permil","mean_n15","std_n15","n15_max","n15_min")]

```
### create & explore
```{r}
# I think I need to calculate %N using the total N in micro grams divided by sample weight
cn$Total_N_mg <- cn$Total_N_g/1000

cn$N_per <- (cn$Total_N_mg/cn$Sample_Weight_mg_from_Sample_List)*100

cn3 <- left_join(cn,spp, by = join_by(Sp_Code))

ggplot(cn3, aes(x=Sp_Code, y=N_per)) +
  geom_violin() + stat_summary(fun.data=mean_sdl, mult=1, 
                 geom="pointrange", color="red") + theme(axis.text.x = element_text(angle=90,hjust = 1, size=14, color="black") )

ggplot(cn3, aes(x=Rating, y=N_per)) +
  geom_violin() + stat_summary(fun.data=mean_sdl, mult=1, 
                 geom="pointrange", color="red") + theme(axis.text.x = element_text(angle=90,hjust = 1, size=14, color="black") )

# Need to create Plant_ID for merging
cn3$Plant_ID <- substr(cn3$Sample_ID, start=1,stop=11)
cn3$Plant_ID <- paste0(
  substr(cn3$Plant_ID, 1, 2),
  ".",
  substr(cn3$Plant_ID, 4, 9),
  ".",
  substr(cn3$Plant_ID, 11, 11)
)
cn3$Plant_ID

cn3$Plot <- substr(cn3$Plant_ID, 1, 2)
cn3$Plot

cn2 <- left_join(cn3,plots,by=join_by("Plot"))

```

## Date of first flower
```{r}
pheno <- read_csv("Phenology_2023.csv")

# Change date to date format
str(pheno)
pheno$Flower_Date <- as.Date(pheno$Flower_Date, tryFormats = "%m/%d/%y")

# Change date into DOY
pheno$doy <- day_of_year(pheno$Flower_Date)

# Extract plot
pheno$Plot <- substr(pheno$Plant_ID,1,2)
pheno$Sp_Code <- pheno$Species

# merge plot info and species info
pheno2 <- left_join(pheno, plots, by=join_by("Plot"))
pheno3 <- left_join(pheno2, spp, by=join_by("Sp_Code"))

ggplot(pheno3, aes(x=Sp_Code, y=doy)) +
  geom_violin() + stat_summary(fun.data=mean_sdl, mult=1, 
                 geom="pointrange", color="red") + theme(axis.text.x = element_text(angle=90,hjust = 1, size=14, color="black") )

ggplot(pheno3, aes(x=Rating, y=doy)) +
  geom_violin() + stat_summary(fun.data=mean_sdl, mult=1, 
                 geom="pointrange", color="red") + theme(axis.text.x = element_text(angle=90,hjust = 1, size=14, color="black") )
```

## All trait analyses

### Merge all traits
Reproductive allocation, `repro_fill_hi_n_narm`
Relative growth rate height, lvs, volume, `rgr_hlv2`
photosynthetic rate, gsw, WUE `licor5`
max ht, `rgr_max_h3`
Leaf Mass Area, Leaf Area, `LMA`
Leaf nitrogen, `cn2`
date of first flower, `pheno3`

```{r}
# take off last two characters from Plant_ID and merge by Plant_ID

head(repro_fill_hi_n_narm)
repro <- repro_fill_hi_n_narm %>% 
  select(
    Plant_ID,
    Flower_Count,
    Veg_Mass,
    total_fl_mass,
    Veg_Mass_ln,
    total_fl_mass_ln
  ) %>% 
  mutate(
    repro_allo = total_fl_mass/(Veg_Mass + total_fl_mass),
    Plant_ID = substr(Plant_ID,1,9)
  )

head(rgr_hlv2)
rgr <- rgr_hlv2 %>%
  select(
    Plant_ID,
    rgr_h_MA,
    rgr_l_MA,
    rgr_v_MA
  ) %>% 
  mutate(
    Plant_ID = substr(Plant_ID,1,9)
  )

head(licor5)
licor <- licor5 %>% 
  select(
    Plant_ID,
    A_adj_av,
    WUE_adj_av,
    E_adj_av,
    Ci_adj_av,
    gsw_adj_av
  ) %>% 
  mutate(
    Plant_ID = substr(Plant_ID,1,9)
  )

head(rgr_max_h3)
ht <- rgr_max_h3 %>% 
  mutate(
    h_max_cm = h_max
  ) %>% 
  select(
    Plant_ID,
    h_max_cm
  ) %>% 
  mutate(
    Plant_ID = substr(Plant_ID,1,9)
  )

head(LMA)
lma <- LMA %>% 
  select(
    Plant_ID,
    area_m2,
    lma_g_m2
  ) %>% 
  mutate(
    Plant_ID = substr(Plant_ID,1,9)
  )

# figure out carbon 13
head(cn2)
cn <- cn2 %>% 
  select(
    Plant_ID,
    N_per
  ) %>% 
  mutate(
    Plant_ID = substr(Plant_ID,1,9)
  )

head(pheno3)
pheno <- pheno3 %>% 
  select(Plant_ID,
         doy) %>% 
  mutate(
    Plant_ID = substr(Plant_ID,1,9)
  )

# merge and scale
full <- full_join(repro,rgr,by=join_by("Plant_ID"))

full2 <- full_join(full,licor,by=join_by("Plant_ID"))

full3 <- full_join(full2,ht,by=join_by("Plant_ID"))

full4 <- full_join(full3, lma,by=join_by("Plant_ID"))

full5 <- full_join(full4, cn,by=join_by("Plant_ID"))

full6 <- full_join(full5, pheno,by=join_by("Plant_ID"))

```

### Correlation Table

### PCA and/or NMDS

```{r}
full6[which(is.na(full6$total_fl_mass)),]

full6_narm <- full6 %>% 
  filter(!is.na(total_fl_mass))

full6_narm$h_max_cm
# There are -Inf values in this column
# force them to be NAs
full6_narm[which(full6_narm$h_max_cm == "-Inf"), "h_max_cm"] <- NA

full6_narm$h_max_cm

full6_anon <- full6_narm %>% 
  select(
    !Plant_ID
  )

library(missMDA)
nb <- estim_ncpPCA(full6_anon)
full_imputed <- imputePCA(full6_anon, ncp = nb$ncp)$completeObs

full_scaled <- scale(full_imputed)

pca <- prcomp(full_scaled, center = TRUE, scale. = TRUE)

# View summary
summary(pca)

# View loadings
pca$rotation

biplot(pca)

pca_scores <- as.data.frame(pca$x)
pca_scores$Plant_ID <- full6_narm$Plant_ID   
# Add grouping variable
pca_scores$Sp_Code <- substr(pca_scores$Plant_ID,4,9)
pca_scores_2 <- left_join(pca_scores,spp, by=join_by("Sp_Code"))

ggplot(pca_scores_2, aes(PC1, PC2, color = Native_Status)) +
  geom_point(size = 3, alpha = 0.8) +
  theme_minimal() +
  labs(title = "PCA of Iris Dataset",
       x = paste0("PC1 (", round(summary(pca)$importance[2,1] * 100, 1), "% variance)"),
       y = paste0("PC2 (", round(summary(pca)$importance[2,2] * 100, 1), "% variance)"))


# Install devtools if needed
library(ggbiplot)

ggbiplot(pca, groups = pca_scores_2$Native_Status, ellipse = TRUE, circle = TRUE) +
  scale_color_discrete(name = "") +
  theme_minimal()

ggsave("pca_native.jpg")

ggbiplot(pca, groups = pca_scores_2$Growth_Habit, ellipse = TRUE, circle = TRUE) +
  scale_color_discrete(name = "") +
  theme_minimal()

ggsave("pca_growth.jpg")

# Need to improve plots and reduce variables
# Make points smaller


# need to figure out if PCAs are used to model reproductive allocation and how to do that. How does a PCA interact with a dependent variable

```


## Mid season biomass partial

## Root biomass partial

## Root:shoot ratio partial

## Root diameter partial

## Specific root length partial

## Root nitrogen partial
